data.v <- inflvir_data
listcountries <- unique(data$report_country) %>% sort()
dir.create(paste0(here::here("reports"),'/output/',reporting.week), showWarnings = FALSE)
week_directory<-paste0(here::here("reports"),'/output/',reporting.week)
dir.create(paste0(week_directory,'/charts'),showWarnings = FALSE)
dir.create(paste0(week_directory,'/reports'),showWarnings = FALSE)
dir.create(paste0(week_directory,'/tests'),showWarnings = FALSE)
template<-'Template_EN.docx'
render(here::here('reports',"Validation_checks.Rmd"),word_document(reference_docx=template,toc=FALSE),
output_file=here::here("reports", 'output',reporting.week,'reports',paste0('Validation_checks-',reporting.week, '.docx')))
png(here::here("reports", "output", reporting.week, "charts", paste0("vaccine-dot-plot-", reporting.week, ".png")), width = 12, height = 8, res = 300, unit="in")
plot_regional_doses_dot(vaccine_data, "English")
dev.off()
if(!exists('regional_level_EN') ||  regional_level_EN == T){
current<-lexical('English') # Very strange but if this line only inside function create_regional_table (and not here), mk_par bugs with current when running for first time. Works when re-running though.
reginfo<-regrep(data, vaccine_data, variant_data, incidence_age_pop, daily_by_week, variant_lookup, reporting.week, over_65_deaths_comparator_week = '2021-01')
template<-'Template_EN_Regional.docx'
render(here::here('reports',"RegionalLevel_EN.Rmd"),word_document(reference_docx=template,toc=FALSE),
output_file=here::here("reports", 'output',reporting.week,'reports',paste0('Regional-',reporting.week, '_EN.docx')))
}
runApp()
install.packages('shinythemes')
library('shinythemes')
runApp()
rm(list = ls())
PackagesToInstall_CRAN<-c('dplyr','rmarkdown','readxl','devtools','webshot')
for (i in PackagesToInstall_CRAN) {
print(i)
if (!i %in% installed.packages())
{install.packages(i)}
library(i, character.only = TRUE)
}
PackagesToInstall_Custom<-c('GetEpiDataNew','WHOCountryNames','GetPopulationNew','SummaryTable')
for (i in PackagesToInstall_Custom) {
print(i)
if (!i %in% installed.packages())
{install_github(paste0('WHOEURO-ECDC/Packages/',i))}
library(i, character.only = TRUE)
}
plain <- function(x,...) {
format(x, ..., scientific = FALSE, trim = TRUE,big.mark=" ")
}
folder<-paste0(dirname(rstudioapi::getActiveDocumentContext()$path),'/InOutDailyList')
pathExtract <- nchar(folder) - nchar("/HIM/DailyList/InOutDailyList")
folder <- substr(folder,1,pathExtract)
runningdataset<-read.csv(paste0(folder,'/qry_COVID_cases_by_date_final.CSV'))
ListSheets<-excel_sheets(paste0(folder,'/VOC Monitoring.xlsx'))
variantdataset<-read_excel(paste0(folder,'/VOC Monitoring.xlsx'), sheet = 'Summary table')[c(3:64),c(1,2,3,5,6,8,9,11,12,15)]
colnames(variantdataset)<-c('ADM0NAME','UK_Date','UK_Cases','SA_Date','SA_Cases','Br_Date','Br_Cases','Ind_Date','v1_617_2','v1_617_Unspecified')
variantdataset<-variantdataset %>% mutate(ADM0NAME=str_to_title(ADM0NAME)) %>%
mutate(UK_Cases=as.numeric(UK_Cases)) %>%
mutate(SA_Cases=as.numeric(SA_Cases)) %>%
mutate(Br_Cases=as.numeric(Br_Cases)) %>%
mutate(v1_617_Unspecified=as.numeric(v1_617_Unspecified)) %>%
#mutate(v1_617_1=as.numeric(v1_617_1)) %>%
mutate(v1_617_2=as.numeric(v1_617_2)) %>%
#mutate(v1_617_3=as.numeric(v1_617_3)) %>%
#mutate(nb_specified=v1_617_1+v1_617_2+v1_617_3) %>%
mutate(check_unspecified=(v1_617_2==0)&(v1_617_Unspecified!=0))
TotalCases_VariantUK<-sum(variantdataset$UK_Cases) %>% plain()
nbCountries_VariantUK<-nrow(variantdataset %>% filter(UK_Date!=0))
TotalCases_VariantSA<-sum(variantdataset$SA_Cases) %>% plain()
nbCountries_VariantSA<-nrow(variantdataset %>% filter(SA_Date!=0))
TotalCases_VariantBr<-sum(variantdataset$Br_Cases) %>% plain()
nbCountries_VariantBr<-nrow(variantdataset %>% filter(Br_Date!=0))
TotalCases_VariantInd<-sum(variantdataset$v1_617_2) %>% plain()
nbCountries_VariantInd<-nrow(variantdataset %>% filter(v1_617_2!=0))
nbCountries_Unspecified_617<-nrow(variantdataset %>% filter(check_unspecified==TRUE))
Table2<-read_excel(paste0(folder,'/EpiDataCOVID19_MASTER.xlsm'), sheet = 'Table2')[c(3:64),c(1:2)]
colnames(Table2)<-make.names(Table2[c(1),])
Table2<-Table2[c(2:62),]  %>% mutate(Last.Reported=as.numeric(Last.Reported)) %>%
mutate(Last.Reported=as.Date(Last.Reported,origin='1899-12-30'))
LastDate <- max(Table2$Last.Reported) #SHould also be TODAY
NbCountriesReporting<-nrow(Table2 %>% filter(Last.Reported==LastDate))
EuroDataset<-GetEpiDataNew() %>%
mutate(ADM0NAME=str_to_title(ADM0NAME))
CurrentDate<-as.Date(max(EuroDataset$DateReport))
CurrentDate_<-format(CurrentDate,"%Y-%m-%d")
DateFull<-format(CurrentDate,'%d %B %Y')
EuroDataset_Today<-EuroDataset %>% filter(DateReport==CurrentDate)
HQDataset<-read.csv('https://covid19.who.int/WHO-COVID-19-global-data.csv',fileEncoding="UTF-8-BOM")
HQDataset_LatestDate<-data.frame()
for (ctr in unique(HQDataset$Country)){
#print(ctr)
HQDataset_ctr<-HQDataset %>% filter(Country==ctr)
maxDate<-max(HQDataset_ctr$Date_reported)
HQData_ctr<-HQDataset_ctr %>% filter(Date_reported==maxDate)
HQDataset_LatestDate<-bind_rows(HQData_ctr,HQDataset_LatestDate)
}
TotalCasesToday_EU<-plain(sum(EuroDataset_Today$NewCases))
TotalDeathsToday_EU<-plain(sum(EuroDataset_Today$NewDeaths))
NbCountriesCasesToday_EU<-nrow(EuroDataset_Today %>% filter(NewCases!=0))
CountriesMore5000Cases_EU<-EuroDataset_Today %>% filter(NewCases>=5000) %>%
arrange(desc(NewCases)) %>% mutate(NewCases=plain(NewCases))
NbCountriesMore5000Cases_EU<-nrow(CountriesMore5000Cases_EU)
ListCountriesOver5000Cases<-function(){
txt<-as.character()
for (i in seq(1,NbCountriesMore5000Cases_EU-1,1)){
txt_<-paste0(CountriesMore5000Cases_EU$ADM0NAME[i],' (',CountriesMore5000Cases_EU$NewCases[i],'), ')
txt<-paste0(txt,txt_)}
txt<-paste0(txt,' and ',CountriesMore5000Cases_EU$ADM0NAME[NbCountriesMore5000Cases_EU],' (',CountriesMore5000Cases_EU$NewCases[NbCountriesMore5000Cases_EU],')')
return(txt)
}
CountriesMore100Deaths_EU<-EuroDataset_Today %>% filter(NewDeaths>=100) %>% arrange(desc(NewDeaths)) %>%
mutate(NewDeaths=plain(NewDeaths))
NbCountriesMore100Deaths_EU<-nrow(CountriesMore100Deaths_EU)
ListCountriesOver100Deaths<-function(){
txt<-as.character()
if(NbCountriesMore100Deaths_EU==1){
txt<-paste0(CountriesMore100Deaths_EU$ADM0NAME[1],' (',CountriesMore100Deaths_EU$NewDeaths[1],'). ')
} else {
for (i in seq(1,NbCountriesMore100Deaths_EU-1,1)){
txt_<-paste0(CountriesMore100Deaths_EU$ADM0NAME[i],' (',CountriesMore100Deaths_EU$NewDeaths[i],'), ')
txt<-paste0(txt,txt_)}
txt<-paste0(txt,' and ',CountriesMore100Deaths_EU$ADM0NAME[NbCountriesMore100Deaths_EU],' (',CountriesMore100Deaths_EU$NewDeaths[NbCountriesMore100Deaths_EU],')')
}
return(txt)
}
SummTable_EU<-SummaryTable(runningdataset)
Top10Countries_7DaysIncidence_EU<-SummTable_EU %>%
filter(Population>=100000) %>%
arrange(desc(SvnDaysIncidence_Latest)) %>%
mutate(SvnDaysIncidence_Latest=round(SvnDaysIncidence_Latest,0))
Top10Countries_7DaysIncidence_Deaths_EU<-SummTable_EU %>%
filter(Population>=100000) %>%
arrange(desc(SvnDaysIncidence_Deaths_Latest)) %>%
mutate(SvnDaysIncidence_Deaths_Latest=round(SvnDaysIncidence_Deaths_Latest,0))
TopCountries_CumCases_EU<-SummTable_EU %>%
arrange(desc(TotalCases)) %>%
mutate(TotalCases=plain(TotalCases))
Top10Countries_CumIncidence_EU<-SummTable_EU %>%
filter(Population>=100000) %>%
arrange(desc(CumulativeIncidence)) %>%
mutate(CumulativeIncidence=plain(round(CumulativeIncidence,0)))
TotalCases_EU<-plain(sum(SummTable_EU$TotalCases))
TotalCases_HQ<-plain(sum(HQDataset_LatestDate$Cumulative_cases))
Share_EU_Cases<-round(sum(SummTable_EU$TotalCases)/sum(HQDataset_LatestDate$Cumulative_cases)*100,0)
TotalDeaths_EU<-plain(sum(SummTable_EU$TotalDeaths))
TotalDeaths_HQ<-plain(sum(HQDataset_LatestDate$Cumulative_deaths))
Share_EU_Deaths<-round(sum(SummTable_EU$TotalDeaths)/sum(HQDataset_LatestDate$Cumulative_deaths)*100,0)
Top3_CumCases_HQ<-HQDataset_LatestDate %>%
arrange(desc(Cumulative_cases)) %>%
top_n(3,Cumulative_cases) %>%
mutate(Cumulative_cases=plain(Cumulative_cases))
CountriesOver30000Deaths_EU<-SummTable_EU %>%
filter(TotalDeaths>=30000) %>% arrange(desc(TotalDeaths)) %>%
mutate(TotalDeaths=plain(TotalDeaths))
Nb_CountriesOver30000Deaths_EU<-nrow(CountriesOver30000Deaths_EU)
ListCountriesOver30000Deaths<-function(){
txt<-as.character()
for (i in seq(1,Nb_CountriesOver30000Deaths_EU-1,1)){
txt_<-paste0(CountriesOver30000Deaths_EU$ADM0NAME[i],' (',CountriesOver30000Deaths_EU$TotalDeaths[i],'), ')
txt<-paste0(txt,txt_)}
txt<-paste0(txt,' and ',CountriesOver30000Deaths_EU$ADM0NAME[Nb_CountriesOver30000Deaths_EU],' (',CountriesOver30000Deaths_EU$TotalDeaths[Nb_CountriesOver30000Deaths_EU],')')
return(txt)
}
render(paste0(folder,"/HIM/DailyList/DailyList.Rmd"),output_file=paste0(folder,'/DailyList_',CurrentDate),word_document(reference_doc= "Template.docx"))
setwd('C:/Users/romanc/Documents/GitHub/Packages/SummaryTable')
use_package('GetPopulationNew',type='Depends')
document()
#Cleans everything (any previously datasets, functions created,..)
rm(list = ls())
PackagesToInstall_CRAN<-c('dplyr','rmarkdown','readxl','devtools','webshot')
for (i in PackagesToInstall_CRAN) {
print(i)
if (!i %in% installed.packages())
{install.packages(i)}
library(i, character.only = TRUE)
}
PackagesToInstall_Custom<-c('GetEpiDataNew','WHOCountryNames','GetPopulationNew','SummaryTable')
for (i in PackagesToInstall_Custom) {
print(i)
if (!i %in% installed.packages())
{install_github(paste0('WHOEURO-ECDC/Packages/',i))}
library(i, character.only = TRUE)
}
plain <- function(x,...) {
format(x, ..., scientific = FALSE, trim = TRUE,big.mark=" ")
}
folder<-paste0(dirname(rstudioapi::getActiveDocumentContext()$path),'/InOutDailyList')
pathExtract <- nchar(folder) - nchar("/HIM/DailyList/InOutDailyList")
folder <- substr(folder,1,pathExtract)
runningdataset<-read.csv(paste0(folder,'/qry_COVID_cases_by_date_final.CSV'))
ListSheets<-excel_sheets(paste0(folder,'/VOC Monitoring.xlsx'))
variantdataset<-read_excel(paste0(folder,'/VOC Monitoring.xlsx'), sheet = 'Summary table')[c(3:64),c(1,2,3,5,6,8,9,11,12,15)]
colnames(variantdataset)<-c('ADM0NAME','UK_Date','UK_Cases','SA_Date','SA_Cases','Br_Date','Br_Cases','Ind_Date','v1_617_2','v1_617_Unspecified')
variantdataset<-variantdataset %>% mutate(ADM0NAME=str_to_title(ADM0NAME)) %>%
mutate(UK_Cases=as.numeric(UK_Cases)) %>%
mutate(SA_Cases=as.numeric(SA_Cases)) %>%
mutate(Br_Cases=as.numeric(Br_Cases)) %>%
mutate(v1_617_Unspecified=as.numeric(v1_617_Unspecified)) %>%
#mutate(v1_617_1=as.numeric(v1_617_1)) %>%
mutate(v1_617_2=as.numeric(v1_617_2)) %>%
#mutate(v1_617_3=as.numeric(v1_617_3)) %>%
#mutate(nb_specified=v1_617_1+v1_617_2+v1_617_3) %>%
mutate(check_unspecified=(v1_617_2==0)&(v1_617_Unspecified!=0))
TotalCases_VariantUK<-sum(variantdataset$UK_Cases) %>% plain()
nbCountries_VariantUK<-nrow(variantdataset %>% filter(UK_Date!=0))
TotalCases_VariantSA<-sum(variantdataset$SA_Cases) %>% plain()
nbCountries_VariantSA<-nrow(variantdataset %>% filter(SA_Date!=0))
TotalCases_VariantBr<-sum(variantdataset$Br_Cases) %>% plain()
nbCountries_VariantBr<-nrow(variantdataset %>% filter(Br_Date!=0))
TotalCases_VariantInd<-sum(variantdataset$v1_617_2) %>% plain()
nbCountries_VariantInd<-nrow(variantdataset %>% filter(v1_617_2!=0))
nbCountries_Unspecified_617<-nrow(variantdataset %>% filter(check_unspecified==TRUE))
Table2<-read_excel(paste0(folder,'/EpiDataCOVID19_MASTER.xlsm'), sheet = 'Table2')[c(3:64),c(1:2)]
colnames(Table2)<-make.names(Table2[c(1),])
Table2<-Table2[c(2:62),]  %>% mutate(Last.Reported=as.numeric(Last.Reported)) %>%
mutate(Last.Reported=as.Date(Last.Reported,origin='1899-12-30'))
LastDate <- max(Table2$Last.Reported) #SHould also be TODAY
NbCountriesReporting<-nrow(Table2 %>% filter(Last.Reported==LastDate))
EuroDataset<-GetEpiDataNew() %>%
mutate(ADM0NAME=str_to_title(ADM0NAME))
CurrentDate<-as.Date(max(EuroDataset$DateReport))
CurrentDate_<-format(CurrentDate,"%Y-%m-%d")
DateFull<-format(CurrentDate,'%d %B %Y')
EuroDataset_Today<-EuroDataset %>% filter(DateReport==CurrentDate)
HQDataset<-read.csv('https://covid19.who.int/WHO-COVID-19-global-data.csv',fileEncoding="UTF-8-BOM")
HQDataset_LatestDate<-data.frame()
for (ctr in unique(HQDataset$Country)){
#print(ctr)
HQDataset_ctr<-HQDataset %>% filter(Country==ctr)
maxDate<-max(HQDataset_ctr$Date_reported)
HQData_ctr<-HQDataset_ctr %>% filter(Date_reported==maxDate)
HQDataset_LatestDate<-bind_rows(HQData_ctr,HQDataset_LatestDate)
}
TotalCasesToday_EU<-plain(sum(EuroDataset_Today$NewCases))
TotalDeathsToday_EU<-plain(sum(EuroDataset_Today$NewDeaths))
NbCountriesCasesToday_EU<-nrow(EuroDataset_Today %>% filter(NewCases!=0))
CountriesMore5000Cases_EU<-EuroDataset_Today %>% filter(NewCases>=5000) %>%
arrange(desc(NewCases)) %>% mutate(NewCases=plain(NewCases))
NbCountriesMore5000Cases_EU<-nrow(CountriesMore5000Cases_EU)
ListCountriesOver5000Cases<-function(){
txt<-as.character()
for (i in seq(1,NbCountriesMore5000Cases_EU-1,1)){
txt_<-paste0(CountriesMore5000Cases_EU$ADM0NAME[i],' (',CountriesMore5000Cases_EU$NewCases[i],'), ')
txt<-paste0(txt,txt_)}
txt<-paste0(txt,' and ',CountriesMore5000Cases_EU$ADM0NAME[NbCountriesMore5000Cases_EU],' (',CountriesMore5000Cases_EU$NewCases[NbCountriesMore5000Cases_EU],')')
return(txt)
}
CountriesMore100Deaths_EU<-EuroDataset_Today %>% filter(NewDeaths>=100) %>% arrange(desc(NewDeaths)) %>%
mutate(NewDeaths=plain(NewDeaths))
NbCountriesMore100Deaths_EU<-nrow(CountriesMore100Deaths_EU)
ListCountriesOver100Deaths<-function(){
txt<-as.character()
if(NbCountriesMore100Deaths_EU==1){
txt<-paste0(CountriesMore100Deaths_EU$ADM0NAME[1],' (',CountriesMore100Deaths_EU$NewDeaths[1],'). ')
} else {
for (i in seq(1,NbCountriesMore100Deaths_EU-1,1)){
txt_<-paste0(CountriesMore100Deaths_EU$ADM0NAME[i],' (',CountriesMore100Deaths_EU$NewDeaths[i],'), ')
txt<-paste0(txt,txt_)}
txt<-paste0(txt,' and ',CountriesMore100Deaths_EU$ADM0NAME[NbCountriesMore100Deaths_EU],' (',CountriesMore100Deaths_EU$NewDeaths[NbCountriesMore100Deaths_EU],')')
}
return(txt)
}
SummTable_EU<-SummaryTable(runningdataset)
Top10Countries_7DaysIncidence_EU<-SummTable_EU %>%
filter(Population>=100000) %>%
arrange(desc(SvnDaysIncidence_Latest)) %>%
mutate(SvnDaysIncidence_Latest=round(SvnDaysIncidence_Latest,0))
Top10Countries_7DaysIncidence_Deaths_EU<-SummTable_EU %>%
filter(Population>=100000) %>%
arrange(desc(SvnDaysIncidence_Deaths_Latest)) %>%
mutate(SvnDaysIncidence_Deaths_Latest=round(SvnDaysIncidence_Deaths_Latest,0))
TopCountries_CumCases_EU<-SummTable_EU %>%
arrange(desc(TotalCases)) %>%
mutate(TotalCases=plain(TotalCases))
Top10Countries_CumIncidence_EU<-SummTable_EU %>%
filter(Population>=100000) %>%
arrange(desc(CumulativeIncidence)) %>%
mutate(CumulativeIncidence=plain(round(CumulativeIncidence,0)))
TotalCases_EU<-plain(sum(SummTable_EU$TotalCases))
TotalCases_HQ<-plain(sum(HQDataset_LatestDate$Cumulative_cases))
Share_EU_Cases<-round(sum(SummTable_EU$TotalCases)/sum(HQDataset_LatestDate$Cumulative_cases)*100,0)
TotalDeaths_EU<-plain(sum(SummTable_EU$TotalDeaths))
TotalDeaths_HQ<-plain(sum(HQDataset_LatestDate$Cumulative_deaths))
Share_EU_Deaths<-round(sum(SummTable_EU$TotalDeaths)/sum(HQDataset_LatestDate$Cumulative_deaths)*100,0)
Top3_CumCases_HQ<-HQDataset_LatestDate %>%
arrange(desc(Cumulative_cases)) %>%
top_n(3,Cumulative_cases) %>%
mutate(Cumulative_cases=plain(Cumulative_cases))
CountriesOver30000Deaths_EU<-SummTable_EU %>%
filter(TotalDeaths>=30000) %>% arrange(desc(TotalDeaths)) %>%
mutate(TotalDeaths=plain(TotalDeaths))
Nb_CountriesOver30000Deaths_EU<-nrow(CountriesOver30000Deaths_EU)
ListCountriesOver30000Deaths<-function(){
txt<-as.character()
for (i in seq(1,Nb_CountriesOver30000Deaths_EU-1,1)){
txt_<-paste0(CountriesOver30000Deaths_EU$ADM0NAME[i],' (',CountriesOver30000Deaths_EU$TotalDeaths[i],'), ')
txt<-paste0(txt,txt_)}
txt<-paste0(txt,' and ',CountriesOver30000Deaths_EU$ADM0NAME[Nb_CountriesOver30000Deaths_EU],' (',CountriesOver30000Deaths_EU$TotalDeaths[Nb_CountriesOver30000Deaths_EU],')')
return(txt)
}
render(paste0(folder,"/HIM/DailyList/DailyList.Rmd"),output_file=paste0(folder,'/DailyList_',CurrentDate),word_document(reference_doc= "Template.docx"))
Dataset_GlobalPopulation <- GetPopulationNew() %>% rename(ADM0NAME=ADM0_NAME) %>% WHOCountryNames(ADM0NAME)
getwd()
document()
SummaryTable<-function(dataset){
EuroDataset<-GetEpiDataNew() %>%
mutate(DateReport=as.Date(DateReport),ADM0NAME=str_to_title(ADM0NAME))
Dataset_Epiforecast_ <- read.csv("https://raw.githubusercontent.com/epiforecasts/covid-rt-estimates/master/national/cases/summary/rt.csv") %>%
filter(type=='estimate')
Rt_country<-function(ctr){
Dataset_Epiforecast_Country<-Dataset_Epiforecast_ %>% filter(country==ctr)
MaxDate<-max(Dataset_Epiforecast_Country$date)
DataMaxDate<-Dataset_Epiforecast_Country %>% filter(date==MaxDate)
return(DataMaxDate)
}
GlobalRtDataset<-data.frame()
for (ctr in unique(Dataset_Epiforecast_$country)){
GlobalRtDataset_<-Rt_country(ctr)
GlobalRtDataset<-bind_rows(GlobalRtDataset,GlobalRtDataset_)
}
Dataset_Epiforecast <- GlobalRtDataset %>%
select(ADM0NAME="country", Last_Update='date',RO='median',CI_low='lower_90', CI_up='upper_90') %>%
mutate(Trend=if_else(CI_low<1 & CI_up<1,"Decreasing",if_else(CI_low<=1 & CI_up>=1,"Stable","Increasing"))) %>%
WHOCountryNames(ADM0NAME)
Dataset_GlobalPopulation <- GetPopulationNew() %>% rename(ADM0NAME=ADM0_NAME) %>% WHOCountryNames(ADM0NAME)
#This will need to change at some point
Dataset_LastReportingDate<-data.frame(ADM0NAME=unique(EuroDataset$ADM0NAME),
LastUpdate=max(EuroDataset$DateReport))#ToCorrectTomorrow
Dataset_TransmissionScenario<-dataset %>%
select(ADM0NAME,TransmissionStatus=STATUS) %>%
mutate(ADM0NAME=str_to_title(ADM0NAME),TransmissionStatus=str_to_title(TransmissionStatus),
TransmissionStatus_FullName=if_else(TransmissionStatus=="Clusters","Clusters of cases",
if_else(TransmissionStatus=="Community","Community Transmission",
if_else(TransmissionStatus=="Sporadic","Sporadic cases","Pending"))))
MainDataset<-EuroDataset %>%
left_join(Dataset_Epiforecast,by="ADM0NAME") %>%
left_join(Dataset_GlobalPopulation,by="ADM0NAME") %>%
left_join(Dataset_TransmissionScenario,by="ADM0NAME")
# Preparing number formatting
plain <- function(x,...) {
format(x, ..., scientific = FALSE, trim = TRUE,big.mark=" ")
}
CurrentDate<-max(EuroDataset$DateReport)
# NbCases_Days('France',14) would give the number of cases in France over the last 14 days (starting from last reporting date)
NbCases_Days<-function(Country,Days){
LastUpdate<-(Dataset_LastReportingDate %>% filter(ADM0NAME==Country))$LastUpdate
if (CurrentDate-LastUpdate<=3){
Cases<-(((MainDataset %>% filter(ADM0NAME==Country,DateReport==LastUpdate))$TotalCases-
(MainDataset %>% filter(ADM0NAME==Country,DateReport==LastUpdate-Days))$TotalCases))}
else {
Cases<-NA
}
return(Cases)
}
TableCases<-data.frame()
for (ctr in unique(MainDataset$ADM0NAME)){
Cases_7Days<-NbCases_Days(ctr,7)
vector<-data.frame(ctr,Cases_7Days)
TableCases<-bind_rows(vector,TableCases)
}
# Function that calculates a certain incidence with a certain delay
# Ex:
# - Incidence('France',14,0) will give the latest 14 days incidence in France
# - Incidence('Kosovo',7,7) will give the 7 days incidence in Kosovo one week before last reporting date.
# The function takes into account potential reporting delays.
# If the delay is more than 3 days, will return NA.
Incidence<-function(country,incidence,delay){
LastUpdate<-(Dataset_LastReportingDate %>% filter(ADM0NAME==country))$LastUpdate
if (CurrentDate-LastUpdate<=3){
Pop<-(Dataset_GlobalPopulation %>% filter(ADM0NAME==country))$Population
Incidence<-round(((MainDataset %>% filter(ADM0NAME==country) %>% filter(DateReport==LastUpdate-delay))$TotalCases-
(MainDataset %>% filter(ADM0NAME==country) %>% filter(DateReport==LastUpdate-incidence-delay))$TotalCases)/Pop*100000,1)}
else {
Incidence<-NA
}
return(Incidence)
}
Incidence_Deaths<-function(country,incidence,delay){
LastUpdate<-(Dataset_LastReportingDate %>% filter(ADM0NAME==country))$LastUpdate
if (CurrentDate-LastUpdate<=3){
Pop<-(Dataset_GlobalPopulation %>% filter(ADM0NAME==country))$Population
Incidence<-round(((MainDataset %>% filter(ADM0NAME==country) %>% filter(DateReport==LastUpdate-delay))$TotalDeaths-
(MainDataset %>% filter(ADM0NAME==country) %>% filter(DateReport==LastUpdate-incidence-delay))$TotalDeaths)/Pop*1000000,1)}
else {
Incidence<-NA
}
return(Incidence)
}
#Creates table all countries and their incidences
TableIncidences<-data.frame()
for (ctr in unique(MainDataset$ADM0NAME)){
FrtDaysIncidence_Latest<-Incidence(ctr,14,0)
FrtDaysIncidence_1WkEarlier<-Incidence(ctr,14,7)
FrtDaysIncidence_2WkEarlier<-Incidence(ctr,14,14)
SvnDaysIncidence_Latest<-Incidence(ctr,7,0)
SvnDaysIncidence_1WkEarlier<-Incidence(ctr,7,7)
SvnDaysIncidence_2WkEarlier<-Incidence(ctr,7,14)
SvnDaysIncidence_Deaths_Latest<-Incidence_Deaths(ctr,7,0)
SvnDaysIncidence_Deaths_1WkEarlier<-Incidence_Deaths(ctr,7,7)
vector<-data.frame(ctr,
FrtDaysIncidence_Latest,
FrtDaysIncidence_1WkEarlier,
FrtDaysIncidence_2WkEarlier,
SvnDaysIncidence_Latest,
SvnDaysIncidence_1WkEarlier,
SvnDaysIncidence_2WkEarlier,
SvnDaysIncidence_Deaths_Latest,
SvnDaysIncidence_Deaths_1WkEarlier
)
TableIncidences<-bind_rows(vector,TableIncidences)
}
#Adds a field that calculates the change in 14days incidence over 2 weeks
TableIncidences<-TableIncidences %>%
mutate(Change14DaysIncidence_2Weeks=round(FrtDaysIncidence_Latest/FrtDaysIncidence_2WkEarlier*100-100,1)) %>%
mutate(Change7DaysIncidence_1week=round(SvnDaysIncidence_Latest/SvnDaysIncidence_1WkEarlier*100-100,1))
SummaryTable_AllCountries<- MainDataset %>% filter(DateReport==CurrentDate) %>%
select(ADM0NAME,TotalCases,TotalDeaths,TransmissionStatus,RO,Trend,Population) %>%
left_join(TableIncidences,by=c('ADM0NAME'='ctr')) %>%
left_join(TableCases,by=c('ADM0NAME'='ctr')) %>%
mutate(CumulativeIncidence=round(TotalCases/Population*100000,1)) %>%
mutate(RateDeaths=round(TotalDeaths/Population*1000000,1))
return(SummaryTable_AllCountries)
}
#Cleans everything (any previously datasets, functions created,..)
rm(list = ls())
PackagesToInstall_CRAN<-c('dplyr','rmarkdown','readxl','devtools','webshot')
for (i in PackagesToInstall_CRAN) {
print(i)
if (!i %in% installed.packages())
{install.packages(i)}
library(i, character.only = TRUE)
}
PackagesToInstall_Custom<-c('GetEpiDataNew','WHOCountryNames','GetPopulationNew','SummaryTable')
for (i in PackagesToInstall_Custom) {
print(i)
if (!i %in% installed.packages())
{install_github(paste0('WHOEURO-ECDC/Packages/',i))}
library(i, character.only = TRUE)
}
plain <- function(x,...) {
format(x, ..., scientific = FALSE, trim = TRUE,big.mark=" ")
}
folder<-paste0(dirname(rstudioapi::getActiveDocumentContext()$path),'/InOutDailyList')
pathExtract <- nchar(folder) - nchar("/HIM/DailyList/InOutDailyList")
folder <- substr(folder,1,pathExtract)
runningdataset<-read.csv(paste0(folder,'/qry_COVID_cases_by_date_final.CSV'))
ListSheets<-excel_sheets(paste0(folder,'/VOC Monitoring.xlsx'))
variantdataset<-read_excel(paste0(folder,'/VOC Monitoring.xlsx'), sheet = 'Summary table')[c(3:64),c(1,2,3,5,6,8,9,11,12,15)]
colnames(variantdataset)<-c('ADM0NAME','UK_Date','UK_Cases','SA_Date','SA_Cases','Br_Date','Br_Cases','Ind_Date','v1_617_2','v1_617_Unspecified')
variantdataset<-variantdataset %>% mutate(ADM0NAME=str_to_title(ADM0NAME)) %>%
mutate(UK_Cases=as.numeric(UK_Cases)) %>%
mutate(SA_Cases=as.numeric(SA_Cases)) %>%
mutate(Br_Cases=as.numeric(Br_Cases)) %>%
mutate(v1_617_Unspecified=as.numeric(v1_617_Unspecified)) %>%
#mutate(v1_617_1=as.numeric(v1_617_1)) %>%
mutate(v1_617_2=as.numeric(v1_617_2)) %>%
#mutate(v1_617_3=as.numeric(v1_617_3)) %>%
#mutate(nb_specified=v1_617_1+v1_617_2+v1_617_3) %>%
mutate(check_unspecified=(v1_617_2==0)&(v1_617_Unspecified!=0))
TotalCases_VariantUK<-sum(variantdataset$UK_Cases) %>% plain()
nbCountries_VariantUK<-nrow(variantdataset %>% filter(UK_Date!=0))
TotalCases_VariantSA<-sum(variantdataset$SA_Cases) %>% plain()
nbCountries_VariantSA<-nrow(variantdataset %>% filter(SA_Date!=0))
TotalCases_VariantBr<-sum(variantdataset$Br_Cases) %>% plain()
nbCountries_VariantBr<-nrow(variantdataset %>% filter(Br_Date!=0))
TotalCases_VariantInd<-sum(variantdataset$v1_617_2) %>% plain()
nbCountries_VariantInd<-nrow(variantdataset %>% filter(v1_617_2!=0))
nbCountries_Unspecified_617<-nrow(variantdataset %>% filter(check_unspecified==TRUE))
Table2<-read_excel(paste0(folder,'/EpiDataCOVID19_MASTER.xlsm'), sheet = 'Table2')[c(3:64),c(1:2)]
colnames(Table2)<-make.names(Table2[c(1),])
Table2<-Table2[c(2:62),]  %>% mutate(Last.Reported=as.numeric(Last.Reported)) %>%
mutate(Last.Reported=as.Date(Last.Reported,origin='1899-12-30'))
LastDate <- max(Table2$Last.Reported) #SHould also be TODAY
NbCountriesReporting<-nrow(Table2 %>% filter(Last.Reported==LastDate))
EuroDataset<-GetEpiDataNew() %>%
mutate(ADM0NAME=str_to_title(ADM0NAME))
CurrentDate<-as.Date(max(EuroDataset$DateReport))
CurrentDate_<-format(CurrentDate,"%Y-%m-%d")
DateFull<-format(CurrentDate,'%d %B %Y')
EuroDataset_Today<-EuroDataset %>% filter(DateReport==CurrentDate)
HQDataset<-read.csv('https://covid19.who.int/WHO-COVID-19-global-data.csv',fileEncoding="UTF-8-BOM")
HQDataset_LatestDate<-data.frame()
for (ctr in unique(HQDataset$Country)){
#print(ctr)
HQDataset_ctr<-HQDataset %>% filter(Country==ctr)
maxDate<-max(HQDataset_ctr$Date_reported)
HQData_ctr<-HQDataset_ctr %>% filter(Date_reported==maxDate)
HQDataset_LatestDate<-bind_rows(HQData_ctr,HQDataset_LatestDate)
}
TotalCasesToday_EU<-plain(sum(EuroDataset_Today$NewCases))
TotalDeathsToday_EU<-plain(sum(EuroDataset_Today$NewDeaths))
NbCountriesCasesToday_EU<-nrow(EuroDataset_Today %>% filter(NewCases!=0))
CountriesMore5000Cases_EU<-EuroDataset_Today %>% filter(NewCases>=5000) %>%
arrange(desc(NewCases)) %>% mutate(NewCases=plain(NewCases))
NbCountriesMore5000Cases_EU<-nrow(CountriesMore5000Cases_EU)
ListCountriesOver5000Cases<-function(){
txt<-as.character()
for (i in seq(1,NbCountriesMore5000Cases_EU-1,1)){
txt_<-paste0(CountriesMore5000Cases_EU$ADM0NAME[i],' (',CountriesMore5000Cases_EU$NewCases[i],'), ')
txt<-paste0(txt,txt_)}
txt<-paste0(txt,' and ',CountriesMore5000Cases_EU$ADM0NAME[NbCountriesMore5000Cases_EU],' (',CountriesMore5000Cases_EU$NewCases[NbCountriesMore5000Cases_EU],')')
return(txt)
}
CountriesMore100Deaths_EU<-EuroDataset_Today %>% filter(NewDeaths>=100) %>% arrange(desc(NewDeaths)) %>%
mutate(NewDeaths=plain(NewDeaths))
NbCountriesMore100Deaths_EU<-nrow(CountriesMore100Deaths_EU)
ListCountriesOver100Deaths<-function(){
txt<-as.character()
if(NbCountriesMore100Deaths_EU==1){
txt<-paste0(CountriesMore100Deaths_EU$ADM0NAME[1],' (',CountriesMore100Deaths_EU$NewDeaths[1],'). ')
} else {
for (i in seq(1,NbCountriesMore100Deaths_EU-1,1)){
txt_<-paste0(CountriesMore100Deaths_EU$ADM0NAME[i],' (',CountriesMore100Deaths_EU$NewDeaths[i],'), ')
txt<-paste0(txt,txt_)}
txt<-paste0(txt,' and ',CountriesMore100Deaths_EU$ADM0NAME[NbCountriesMore100Deaths_EU],' (',CountriesMore100Deaths_EU$NewDeaths[NbCountriesMore100Deaths_EU],')')
}
return(txt)
}
SummTable_EU<-SummaryTable(runningdataset)
