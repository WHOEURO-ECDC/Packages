filter(!is.na(DateReport1)) %>%
filter(ADM0NAME %in% unique(StringencyIndex$ADM0NAME)) %>%
mutate(NewCases = if_else(is.na(NewCases),0,NewCases),
NewDeaths = if_else(is.na(NewDeaths),0,NewDeaths),
TotalCases = if_else(is.na(TotalCases),0,TotalCases),
TotalDeaths = if_else(is.na(TotalDeaths),0,TotalDeaths)) %>%
#left_join(StringencyIndex,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_SeverityIndex,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_Masks,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_Schools,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_Businesses,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_Borders,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_Gatherings,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_Movements,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date"))
RelativeDays<-function(ctr){
DatasetCountry<-MainDataset %>% filter(ADM0NAME==ctr)
minDateAll<-min((DatasetCountry %>% filter(!is.na(Narrative_All)))$DateReport1)
minDateSchools<-min((DatasetCountry %>% filter(!is.na(Narrative_Schools)))$DateReport1)
minDateMasks<-min((DatasetCountry %>% filter(!is.na(Narrative_Masks)))$DateReport1)
minDateGatherings<-min((DatasetCountry %>% filter(!is.na(Narrative_Gatherings)))$DateReport1)
minDateBusinesses<-min((DatasetCountry %>% filter(!is.na(Narrative_Businesses)))$DateReport1)
minDateBorders<-min((DatasetCountry %>% filter(!is.na(Narrative_Borders)))$DateReport1)
minDateMovements<-min((DatasetCountry %>% filter(!is.na(Narrative_Movements)))$DateReport1)
DatasetCountry<-DatasetCountry %>% mutate(Days_All=DateReport1-minDateAll) %>%
mutate(Days_Schools=as.numeric(DateReport1-minDateSchools)) %>%
mutate(Days_Masks=as.numeric(DateReport1-minDateMasks)) %>%
mutate(Days_Gatherings=as.numeric(DateReport1-minDateGatherings)) %>%
mutate(Days_Movements=as.numeric(DateReport1-minDateMovements)) %>%
mutate(Days_Borders=as.numeric(DateReport1-minDateBorders)) %>%
mutate(Days_Businesses=as.numeric(DateReport1-minDateBusinesses))
return(DatasetCountry)
}
BuildNewDataset<-function(ctr){
CountryDataset<-RelativeDays(ctr)
CountryDataset<-CountryDataset %>%
mutate(ThreeDaysAverage_Cases=(NewCases+lag(NewCases,1)+lead(NewCases,1))/3,
ThreeDaysAverage_Deaths=(NewDeaths+lag(NewDeaths,1)+lead(NewDeaths,1))/3)
CountryDataset_<-CountryDataset %>% select(-c("WHO_Code","epiWeek")) %>%
mutate(log10_MovingAverage_Cases=log10(ThreeDaysAverage_Cases),
log10_MovingAverage_Deaths=log10(ThreeDaysAverage_Deaths))
return(CountryDataset_)
}
DatasetToSmooth<-function(ctr){
CountryDataset<-BuildNewDataset(ctr)
CountryDataset<-CountryDataset %>% mutate(log_cases=log10(NewCases),log_deaths=log10(NewDeaths))
return(CountryDataset)}
DatasetWithSplineValues<-function(ctr){
CountryDataset<-DatasetToSmooth(ctr)
CountryDataset_Cases<-DatasetToSmooth(ctr) %>% filter(!is.na(ThreeDaysAverage_Cases)) %>% select(DateReport1,ThreeDaysAverage_Cases)
CountryDataset_Deaths<-DatasetToSmooth(ctr) %>% filter(!is.na(ThreeDaysAverage_Deaths)) %>% select(DateReport1,ThreeDaysAverage_Deaths)
CountryDataset_logCases<-DatasetToSmooth(ctr) %>% filter(!is.na(log10_MovingAverage_Cases)) %>%
select(DateReport1,log10_MovingAverage_Cases) %>% filter(log10_MovingAverage_Cases!=-Inf)
CountryDataset_logDeaths<-DatasetToSmooth(ctr) %>% filter(!is.na(log10_MovingAverage_Deaths)) %>%
select(DateReport1,log10_MovingAverage_Deaths) %>% filter(log10_MovingAverage_Deaths!=-Inf)
Spline_3DaysAverageCases<-smooth.spline(x=CountryDataset_Cases$DateReport1,y=CountryDataset_Cases$ThreeDaysAverage_Cases,spar=0.5)
Spline_3DaysAverageDeaths<-smooth.spline(x=CountryDataset_Deaths$DateReport1,y=CountryDataset_Deaths$ThreeDaysAverage_Deaths,spar=0.5)
Spline_3DaysAverage_LogCases<-smooth.spline(x=CountryDataset_logCases$DateReport1,y=CountryDataset_logCases$log10_MovingAverage_Cases,spar=0.5)
Spline_3DaysAverage_LogDeaths<-smooth.spline(x=CountryDataset_logDeaths$DateReport1,y=CountryDataset_logDeaths$log10_MovingAverage_Deaths,spar=0.5)
ValuesSpline_3DaysAverageCases<-data.frame(SplineValue_3DaysAverageCases=predict(Spline_3DaysAverageCases,deriv=0))
ValuesSpline_3DaysAverageDeaths<-data.frame(SplineValue_3DaysAverageDeaths=predict(Spline_3DaysAverageDeaths,deriv=0))
ValuesSpline_3DaysAverage_LogCases<-data.frame(SplineValue_3DaysAverage_LogCases=predict(Spline_3DaysAverage_LogCases,deriv=0))
ValuesSpline_3DaysAverage_LogDeaths<-data.frame(SplineValue_3DaysAverage_LogDeaths=predict(Spline_3DaysAverage_LogDeaths,deriv=0))
CountryDataset_Cases<-data.frame(CountryDataset_Cases,ValuesSpline_3DaysAverageCases) %>%
select(DateReport1,"Spline_3DaysAverageCases"="SplineValue_3DaysAverageCases.y")
CountryDataset_Deaths<-data.frame(CountryDataset_Deaths,ValuesSpline_3DaysAverageDeaths) %>%
select(DateReport1,"Spline_3DaysAverageDeaths"="SplineValue_3DaysAverageDeaths.y")
CountryDataset_logCases<-data.frame(CountryDataset_logCases,ValuesSpline_3DaysAverage_LogCases) %>%
select(DateReport1,"Spline_3DaysAverage_logCases"="SplineValue_3DaysAverage_LogCases.y")
CountryDataset_logDeaths<-data.frame(CountryDataset_logDeaths,ValuesSpline_3DaysAverage_LogDeaths) %>%
select(DateReport1,"Spline_3DaysAverage_logDeaths"="SplineValue_3DaysAverage_LogDeaths.y")
CountryDataset_<-CountryDataset %>%
left_join(CountryDataset_Cases,by='DateReport1') %>%
left_join(CountryDataset_Deaths,by='DateReport1') %>%
left_join(CountryDataset_logCases,by='DateReport1') %>%
left_join(CountryDataset_logDeaths,by='DateReport1')
x <- zoo(CountryDataset_$Spline_3DaysAverage_logCases,CountryDataset_$DateReport1)
x <- na_interpolation(x, option = "linear") %>% fortify.zoo
y <- zoo(CountryDataset_$Spline_3DaysAverage_logDeaths,CountryDataset_$DateReport1)
y <- na_interpolation(y, option = "linear") %>% fortify.zoo
CountryDataset_<-CountryDataset_ %>% left_join(x,by=c('DateReport1'='Index')) %>% rename(Spline_3DaysAverage_logCases_='.')
CountryDataset_<-CountryDataset_ %>% left_join(y,by=c('DateReport1'='Index')) %>% rename(Spline_3DaysAverage_logDeaths_='.')
return(CountryDataset_)
}
CheckAtLeast4Values<-function(){
ListCountriesOkToSpline<-data.frame()
for (ctr in unique(MainDataset$ADM0NAME)){
CountryDataset<-MainDataset %>% filter(ADM0NAME==ctr)
CountryDataset<-CountryDataset %>% filter(NewDeaths!=0)
if ((nrow(CountryDataset)) > 3){
ListCountriesOkToSpline<-c(ctr,ListCountriesOkToSpline)}
}
return(ListCountriesOkToSpline)}
GlobalDataset_<-data.frame()
for (ctr in CheckAtLeast4Values()){
GlobalDataset<-DatasetWithSplineValues(ctr)
GlobalDataset_<-bind_rows(GlobalDataset_,GlobalDataset)
}
write.csv(GlobalDataset_,paste0(folderOutput,'/GlobalDataset.csv'))
runApp('GitHub/Shiny_PHSM/app_single')
PackagesToInstall<-c('imputeTS','zoo',"hablar","ggsci",'BBmisc',"stringr","magick","gridExtra","lubridate","readxl","RColorBrewer","ggplot2","dplyr","rmarkdown","kableExtra","flextable","ggpubr","knitr","scales","tidyr","scales","xml2","rvest","qdapRegex",'cowplot')
for (i in PackagesToInstall) {
print(i)
if (!i %in% installed.packages())
{install.packages(i)}
library(i, character.only = TRUE)
}
folder_<-dirname(rstudioapi::getSourceEditorContext()$path)
folderInput_1<-paste0(folder_,'/input_step2')
folderInput_2<-paste0(folder_,'/output_step1')
folderOutput<-paste0(folder_,'/output_step2')
folderApp_Single<-paste0(dirname(folder_),'/app_single')
folderApp_Multiple<-paste0(dirname(folder_),'/app_multiple')
StringencyIndex<-read.csv(paste0(folderInput_2,'/StringencyIndex.csv'))
StringencyIndex<-StringencyIndex %>% rename(Schools=School,Businesses=Workplace,Movements=StayHome,Borders=Travels) %>%
mutate(Date=as.Date(Date)) %>% mutate(ADM0NAME=if_else(ADM0NAME=='Republic of Moldova','Republic Of Moldova',ADM0NAME),
ADM0NAME=if_else(ADM0NAME=='Bosnia and Herzegovina','Bosnia And Herzegovina',ADM0NAME)) %>%
arrange(ADM0NAME)
KeyDates_SeverityIndex<-read_excel(paste0(folderInput_1,'/KeyDates.xlsx'),sheet='Severity Index') %>%
mutate(Date=as.Date(parse_date_time(Date,c("dmy", "ymd","mdy")))) %>%
select(Date,ADM0NAME,Narrative_All) %>%
mutate(ADM0NAME=if_else(ADM0NAME=='Republic of Moldova','Republic Of Moldova',ADM0NAME),
ADM0NAME=if_else(ADM0NAME=='Bosnia and Herzegovina','Bosnia And Herzegovina',ADM0NAME))
KeyDates_Schools<-read_excel(paste0(folderInput_1,'/KeyDates.xlsx'),sheet='Schools') %>%
mutate(Date=as.Date(parse_date_time(Date,c("dmy", "ymd","mdy")))) %>%
select(Date,ADM0NAME,Narrative_Schools) %>%
mutate(ADM0NAME=if_else(ADM0NAME=='Republic of Moldova','Republic Of Moldova',ADM0NAME),
ADM0NAME=if_else(ADM0NAME=='Bosnia and Herzegovina','Bosnia And Herzegovina',ADM0NAME))
KeyDates_Masks<-read_excel(paste0(folderInput_1,'/KeyDates.xlsx'),sheet='Masks') %>%
mutate(Date=as.Date(parse_date_time(Date,c("dmy", "ymd","mdy")))) %>%
select(Date,ADM0NAME,Narrative_Masks) %>%
mutate(ADM0NAME=if_else(ADM0NAME=='Republic of Moldova','Republic Of Moldova',ADM0NAME),
ADM0NAME=if_else(ADM0NAME=='Bosnia and Herzegovina','Bosnia And Herzegovina',ADM0NAME))
KeyDates_Businesses<-read_excel(paste0(folderInput_1,'/KeyDates.xlsx'),sheet='Businesses') %>%
mutate(Date=as.Date(parse_date_time(Date,c("dmy", "ymd","mdy")))) %>%
select(Date,ADM0NAME,Narrative_Businesses) %>%
mutate(ADM0NAME=if_else(ADM0NAME=='Republic of Moldova','Republic Of Moldova',ADM0NAME),
ADM0NAME=if_else(ADM0NAME=='Bosnia and Herzegovina','Bosnia And Herzegovina',ADM0NAME))
KeyDates_Movements<-read_excel(paste0(folderInput_1,'/KeyDates.xlsx'),sheet='Movements') %>%
mutate(Date=as.Date(parse_date_time(Date,c("dmy", "ymd","mdy")))) %>%
select(Date,ADM0NAME,Narrative_Movements)
KeyDates_Borders<-read_excel(paste0(folderInput_1,'/KeyDates.xlsx'),sheet='Borders') %>%
mutate(Date=as.Date(parse_date_time(Date,c("dmy", "ymd","mdy")))) %>%
select(Date,ADM0NAME,Narrative_Borders) %>%
mutate(ADM0NAME=if_else(ADM0NAME=='Republic of Moldova','Republic Of Moldova',ADM0NAME),
ADM0NAME=if_else(ADM0NAME=='Bosnia and Herzegovina','Bosnia And Herzegovina',ADM0NAME))
KeyDates_Gatherings<-read_excel(paste0(folderInput_1,'/KeyDates.xlsx'),sheet='Gatherings') %>%
mutate(Date=as.Date(parse_date_time(Date,c("dmy", "ymd","mdy"))))%>%
select(Date,ADM0NAME,Narrative_Gatherings) %>%
mutate(ADM0NAME=if_else(ADM0NAME=='Republic of Moldova','Republic Of Moldova',ADM0NAME),
ADM0NAME=if_else(ADM0NAME=='Bosnia and Herzegovina','Bosnia And Herzegovina',ADM0NAME))
MainDataset<-read.csv(paste0(folderInput_1,"/qry_covid_running_cases_country_date.CSV")) %>%
mutate(ADM0NAME=str_to_title(ADM0NAME),
DateReport1=as.Date(parse_date_time(DateReport1,c("dmy", "ymd","mdy")))) %>%
mutate(ADM0NAME=if_else(ADM0NAME=='Kosovo','Kosovo(1)',ADM0NAME))
MainDataset<-MainDataset %>%
merge(StringencyIndex,by.x=c('DateReport1','ADM0NAME'),by.y=c('Date','ADM0NAME'),all=TRUE) %>%
filter(!is.na(DateReport1)) %>%
filter(ADM0NAME %in% unique(StringencyIndex$ADM0NAME)) %>%
mutate(NewCases = if_else(is.na(NewCases),0,NewCases),
NewDeaths = if_else(is.na(NewDeaths),0,NewDeaths),
TotalCases = if_else(is.na(TotalCases),0,TotalCases),
TotalDeaths = if_else(is.na(TotalDeaths),0,TotalDeaths)) %>%
#left_join(StringencyIndex,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_SeverityIndex,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_Masks,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_Schools,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_Businesses,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_Borders,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_Gatherings,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date")) %>%
left_join(KeyDates_Movements,by=c("ADM0NAME" = "ADM0NAME", "DateReport1" = "Date"))
RelativeDays<-function(ctr){
DatasetCountry<-MainDataset %>% filter(ADM0NAME==ctr)
minDateAll<-min((DatasetCountry %>% filter(!is.na(Narrative_All)))$DateReport1)
minDateSchools<-min((DatasetCountry %>% filter(!is.na(Narrative_Schools)))$DateReport1)
minDateMasks<-min((DatasetCountry %>% filter(!is.na(Narrative_Masks)))$DateReport1)
minDateGatherings<-min((DatasetCountry %>% filter(!is.na(Narrative_Gatherings)))$DateReport1)
minDateBusinesses<-min((DatasetCountry %>% filter(!is.na(Narrative_Businesses)))$DateReport1)
minDateBorders<-min((DatasetCountry %>% filter(!is.na(Narrative_Borders)))$DateReport1)
minDateMovements<-min((DatasetCountry %>% filter(!is.na(Narrative_Movements)))$DateReport1)
DatasetCountry<-DatasetCountry %>% mutate(Days_All=DateReport1-minDateAll) %>%
mutate(Days_Schools=as.numeric(DateReport1-minDateSchools)) %>%
mutate(Days_Masks=as.numeric(DateReport1-minDateMasks)) %>%
mutate(Days_Gatherings=as.numeric(DateReport1-minDateGatherings)) %>%
mutate(Days_Movements=as.numeric(DateReport1-minDateMovements)) %>%
mutate(Days_Borders=as.numeric(DateReport1-minDateBorders)) %>%
mutate(Days_Businesses=as.numeric(DateReport1-minDateBusinesses))
return(DatasetCountry)
}
BuildNewDataset<-function(ctr){
CountryDataset<-RelativeDays(ctr)
CountryDataset<-CountryDataset %>%
mutate(ThreeDaysAverage_Cases=(NewCases+lag(NewCases,1)+lead(NewCases,1))/3,
ThreeDaysAverage_Deaths=(NewDeaths+lag(NewDeaths,1)+lead(NewDeaths,1))/3)
CountryDataset_<-CountryDataset %>% select(-c("WHO_Code","epiWeek")) %>%
mutate(log10_MovingAverage_Cases=log10(ThreeDaysAverage_Cases),
log10_MovingAverage_Deaths=log10(ThreeDaysAverage_Deaths))
return(CountryDataset_)
}
DatasetToSmooth<-function(ctr){
CountryDataset<-BuildNewDataset(ctr)
CountryDataset<-CountryDataset %>% mutate(log_cases=log10(NewCases),log_deaths=log10(NewDeaths))
return(CountryDataset)}
DatasetWithSplineValues<-function(ctr){
CountryDataset<-DatasetToSmooth(ctr)
CountryDataset_Cases<-DatasetToSmooth(ctr) %>% filter(!is.na(ThreeDaysAverage_Cases)) %>% select(DateReport1,ThreeDaysAverage_Cases)
CountryDataset_Deaths<-DatasetToSmooth(ctr) %>% filter(!is.na(ThreeDaysAverage_Deaths)) %>% select(DateReport1,ThreeDaysAverage_Deaths)
CountryDataset_logCases<-DatasetToSmooth(ctr) %>% filter(!is.na(log10_MovingAverage_Cases)) %>%
select(DateReport1,log10_MovingAverage_Cases) %>% filter(log10_MovingAverage_Cases!=-Inf)
CountryDataset_logDeaths<-DatasetToSmooth(ctr) %>% filter(!is.na(log10_MovingAverage_Deaths)) %>%
select(DateReport1,log10_MovingAverage_Deaths) %>% filter(log10_MovingAverage_Deaths!=-Inf)
Spline_3DaysAverageCases<-smooth.spline(x=CountryDataset_Cases$DateReport1,y=CountryDataset_Cases$ThreeDaysAverage_Cases,spar=0.5)
Spline_3DaysAverageDeaths<-smooth.spline(x=CountryDataset_Deaths$DateReport1,y=CountryDataset_Deaths$ThreeDaysAverage_Deaths,spar=0.5)
Spline_3DaysAverage_LogCases<-smooth.spline(x=CountryDataset_logCases$DateReport1,y=CountryDataset_logCases$log10_MovingAverage_Cases,spar=0.5)
Spline_3DaysAverage_LogDeaths<-smooth.spline(x=CountryDataset_logDeaths$DateReport1,y=CountryDataset_logDeaths$log10_MovingAverage_Deaths,spar=0.5)
ValuesSpline_3DaysAverageCases<-data.frame(SplineValue_3DaysAverageCases=predict(Spline_3DaysAverageCases,deriv=0))
ValuesSpline_3DaysAverageDeaths<-data.frame(SplineValue_3DaysAverageDeaths=predict(Spline_3DaysAverageDeaths,deriv=0))
ValuesSpline_3DaysAverage_LogCases<-data.frame(SplineValue_3DaysAverage_LogCases=predict(Spline_3DaysAverage_LogCases,deriv=0))
ValuesSpline_3DaysAverage_LogDeaths<-data.frame(SplineValue_3DaysAverage_LogDeaths=predict(Spline_3DaysAverage_LogDeaths,deriv=0))
CountryDataset_Cases<-data.frame(CountryDataset_Cases,ValuesSpline_3DaysAverageCases) %>%
select(DateReport1,"Spline_3DaysAverageCases"="SplineValue_3DaysAverageCases.y")
CountryDataset_Deaths<-data.frame(CountryDataset_Deaths,ValuesSpline_3DaysAverageDeaths) %>%
select(DateReport1,"Spline_3DaysAverageDeaths"="SplineValue_3DaysAverageDeaths.y")
CountryDataset_logCases<-data.frame(CountryDataset_logCases,ValuesSpline_3DaysAverage_LogCases) %>%
select(DateReport1,"Spline_3DaysAverage_logCases"="SplineValue_3DaysAverage_LogCases.y")
CountryDataset_logDeaths<-data.frame(CountryDataset_logDeaths,ValuesSpline_3DaysAverage_LogDeaths) %>%
select(DateReport1,"Spline_3DaysAverage_logDeaths"="SplineValue_3DaysAverage_LogDeaths.y")
CountryDataset_<-CountryDataset %>%
left_join(CountryDataset_Cases,by='DateReport1') %>%
left_join(CountryDataset_Deaths,by='DateReport1') %>%
left_join(CountryDataset_logCases,by='DateReport1') %>%
left_join(CountryDataset_logDeaths,by='DateReport1')
x <- zoo(CountryDataset_$Spline_3DaysAverage_logCases,CountryDataset_$DateReport1)
x <- na_interpolation(x, option = "linear") %>% fortify.zoo
y <- zoo(CountryDataset_$Spline_3DaysAverage_logDeaths,CountryDataset_$DateReport1)
y <- na_interpolation(y, option = "linear") %>% fortify.zoo
CountryDataset_<-CountryDataset_ %>% left_join(x,by=c('DateReport1'='Index')) %>% rename(Spline_3DaysAverage_logCases_='.')
CountryDataset_<-CountryDataset_ %>% left_join(y,by=c('DateReport1'='Index')) %>% rename(Spline_3DaysAverage_logDeaths_='.')
return(CountryDataset_)
}
CheckAtLeast4Values<-function(){
ListCountriesOkToSpline<-data.frame()
for (ctr in unique(MainDataset$ADM0NAME)){
CountryDataset<-MainDataset %>% filter(ADM0NAME==ctr)
CountryDataset<-CountryDataset %>% filter(NewDeaths!=0)
if ((nrow(CountryDataset)) > 3){
ListCountriesOkToSpline<-c(ctr,ListCountriesOkToSpline)}
}
return(ListCountriesOkToSpline)}
GlobalDataset_<-data.frame()
for (ctr in CheckAtLeast4Values()){
GlobalDataset<-DatasetWithSplineValues(ctr)
GlobalDataset_<-bind_rows(GlobalDataset_,GlobalDataset)
}
write.csv(GlobalDataset_,paste0(folderOutput,'/GlobalDataset.csv'))
runApp('GitHub/Shiny_PHSM/app_single')
runApp('GitHub/Shiny_PHSM/app_multiple')
runApp('GitHub/Shiny_PHSM/app_multiple')
#import relevant packages
library(xlsx)
library(tidyverse)
library(scales)
library(rmarkdown)
#devtools::install_github("whocov/phifunc", auth_token = "7fb165f058a1f42c930f75328578253e08028453", subdir = "phifunc", dep = FALSE)
library(phifunc)
library(readxl)
library(cowplot)
library(ISOweek)
library(httr) # for working with APIs
library(jsonlite) #for working with APIs
library(openxlsx)
library(rvest)
library(assertthat)
library(lubridate)
library(flextable)
library(officer)
library(fst)
library(here)
source(here::here("R", "utils", "calc_previous_iso_week.R"))
# specify reporting week - if null system date minus 6 days is used (in format 2021-03)
reporting.week <- NULL
# define weeks of relevance
if (is.null(reporting.week)) {
today_day <- lubridate::wday(Sys.Date(), week_start=1)
if (today_day < 4) {
reporting.week <- str_replace(ISOweek(Sys.Date() - 7 - today_day), "W", "")
} else {
reporting.week <- str_replace(ISOweek(Sys.Date() - 7), "W", "")
}
}
previous.week <- calc_previous_iso_week(reporting.week)
source(here::here("scripts", "pull_data.R"), local = TRUE)
#source other functions
functions <- list.files(here::here('R'), pattern = ".R$", recursive = TRUE)
folder<-paste0(dirname(rstudioapi::getActiveDocumentContext()$path),'/InOutDailyList')
pathExtract <- nchar(folder) - nchar("/HIM/DailyList/InOutDailyList")
folder <- substr(folder,1,pathExtract)
runningdataset<-read.csv(paste0(folder,'/qry_COVID_cases_by_date_final.CSV'))
folder<-paste0(dirname(rstudioapi::getActiveDocumentContext()$path),'/InOutDailyList')
pathExtract <- nchar(folder) - nchar("/HIM/DailyList/InOutDailyList")
folder <- substr(folder,1,pathExtract)
runningdataset<-read.csv(paste0(folder,'/qry_COVID_cases_by_date_final.CSV'))
EuroDataset<-GetEpiData() %>%
mutate(DateReport=as.Date(DateReport),ADM0NAME=str_to_title(ADM0NAME))
library(dplyr)
EuroDataset<-GetEpiData() %>%
mutate(DateReport=as.Date(DateReport),ADM0NAME=str_to_title(ADM0NAME))
EuroDataset<-GetEpiData() %>%
mutate(DateReport=as.Date(DateReport),ADM0NAME=str_to_title(ADM0NAME))
Dataset_Epiforecast_ <- read.csv("https://raw.githubusercontent.com/epiforecasts/covid-rt-estimates/master/national/cases/summary/rt.csv") %>%
filter(type=='estimate')
Rt_country<-function(ctr){
Dataset_Epiforecast_Country<-Dataset_Epiforecast_ %>% filter(country==ctr)
MaxDate<-max(Dataset_Epiforecast_Country$date)
DataMaxDate<-Dataset_Epiforecast_Country %>% filter(date==MaxDate)
return(DataMaxDate)
}
GlobalRtDataset<-data.frame()
for (ctr in unique(Dataset_Epiforecast_$country)){
GlobalRtDataset_<-Rt_country(ctr)
GlobalRtDataset<-bind_rows(GlobalRtDataset,GlobalRtDataset_)
}
Dataset_Epiforecast <- GlobalRtDataset %>%
select(ADM0NAME="country", Last_Update='date',RO='median',CI_low='lower_90', CI_up='upper_90') %>%
mutate(Trend=if_else(CI_low<1 & CI_up<1,"Decreasing",if_else(CI_low<=1 & CI_up>=1,"Stable","Increasing"))) %>%
WHOCountryNames(ADM0NAME)
library(WhoCountryNames)
library(WHOCountryNames)
Dataset_Epiforecast_ <- read.csv("https://raw.githubusercontent.com/epiforecasts/covid-rt-estimates/master/national/cases/summary/rt.csv") %>%
filter(type=='estimate')
Rt_country<-function(ctr){
Dataset_Epiforecast_Country<-Dataset_Epiforecast_ %>% filter(country==ctr)
MaxDate<-max(Dataset_Epiforecast_Country$date)
DataMaxDate<-Dataset_Epiforecast_Country %>% filter(date==MaxDate)
return(DataMaxDate)
}
GlobalRtDataset<-data.frame()
for (ctr in unique(Dataset_Epiforecast_$country)){
GlobalRtDataset_<-Rt_country(ctr)
GlobalRtDataset<-bind_rows(GlobalRtDataset,GlobalRtDataset_)
}
Dataset_Epiforecast <- GlobalRtDataset %>%
select(ADM0NAME="country", Last_Update='date',RO='median',CI_low='lower_90', CI_up='upper_90') %>%
mutate(Trend=if_else(CI_low<1 & CI_up<1,"Decreasing",if_else(CI_low<=1 & CI_up>=1,"Stable","Increasing"))) %>%
WHOCountryNames(ADM0NAME)
Dataset_GlobalPopulation <- GetPopulation() %>% rename(ADM0NAME=ADM0_NAME)
library(GetPopulation)
Dataset_GlobalPopulation <- GetPopulation() %>% rename(ADM0NAME=ADM0_NAME)
library(dplyr)
library(GetEpiData)
library(SummaryTable)
library(WHOCountryNames)
library(GetPopulation)
folder<-paste0(dirname(rstudioapi::getActiveDocumentContext()$path),'/InOutDailyList')
pathExtract <- nchar(folder) - nchar("/HIM/DailyList/InOutDailyList")
folder <- substr(folder,1,pathExtract)
runningdataset<-read.csv(paste0(folder,'/qry_COVID_cases_by_date_final.CSV'))
EuroDataset<-GetEpiData() %>%
mutate(DateReport=as.Date(DateReport),ADM0NAME=str_to_title(ADM0NAME))
Dataset_Epiforecast_ <- read.csv("https://raw.githubusercontent.com/epiforecasts/covid-rt-estimates/master/national/cases/summary/rt.csv") %>%
filter(type=='estimate')
Rt_country<-function(ctr){
Dataset_Epiforecast_Country<-Dataset_Epiforecast_ %>% filter(country==ctr)
MaxDate<-max(Dataset_Epiforecast_Country$date)
DataMaxDate<-Dataset_Epiforecast_Country %>% filter(date==MaxDate)
return(DataMaxDate)
}
GlobalRtDataset<-data.frame()
for (ctr in unique(Dataset_Epiforecast_$country)){
GlobalRtDataset_<-Rt_country(ctr)
GlobalRtDataset<-bind_rows(GlobalRtDataset,GlobalRtDataset_)
}
Dataset_Epiforecast <- GlobalRtDataset %>%
select(ADM0NAME="country", Last_Update='date',RO='median',CI_low='lower_90', CI_up='upper_90') %>%
mutate(Trend=if_else(CI_low<1 & CI_up<1,"Decreasing",if_else(CI_low<=1 & CI_up>=1,"Stable","Increasing"))) %>%
WHOCountryNames(ADM0NAME)
Dataset_GlobalPopulation <- GetPopulation() %>% rename(ADM0NAME=ADM0_NAME)
Dataset_LastReportingDate<-data.frame(ADM0NAME=unique(EuroDataset$ADM0NAME),
LastUpdate=max(EuroDataset$DateReport))#ToCorrectTomorrow
Dataset_TransmissionScenario<-dataset %>%
select(ADM0NAME,TransmissionStatus=STATUS) %>%
mutate(ADM0NAME=str_to_title(ADM0NAME),TransmissionStatus=str_to_title(TransmissionStatus),
TransmissionStatus_FullName=if_else(TransmissionStatus=="Clusters","Clusters of cases",
if_else(TransmissionStatus=="Community","Community Transmission",
if_else(TransmissionStatus=="Sporadic","Sporadic cases","Pending"))))
dataset<-read.csv(paste0(folder,'/qry_COVID_cases_by_date_final.CSV'))
Dataset_TransmissionScenario<-dataset %>%
select(ADM0NAME,TransmissionStatus=STATUS) %>%
mutate(ADM0NAME=str_to_title(ADM0NAME),TransmissionStatus=str_to_title(TransmissionStatus),
TransmissionStatus_FullName=if_else(TransmissionStatus=="Clusters","Clusters of cases",
if_else(TransmissionStatus=="Community","Community Transmission",
if_else(TransmissionStatus=="Sporadic","Sporadic cases","Pending"))))
MainDataset<-EuroDataset %>%
left_join(Dataset_Epiforecast,by="ADM0NAME") %>%
left_join(Dataset_GlobalPopulation,by="ADM0NAME") %>%
left_join(Dataset_TransmissionScenario,by="ADM0NAME")
plain <- function(x,...) {
format(x, ..., scientific = FALSE, trim = TRUE,big.mark=" ")
}
CurrentDate<-max(EuroDataset$DateReport)
NbCases_Days<-function(Country,Days){
LastUpdate<-(Dataset_LastReportingDate %>% filter(ADM0NAME==Country))$LastUpdate
if (CurrentDate-LastUpdate<=3){
Cases<-(((MainDataset %>% filter(ADM0NAME==Country,DateReport==LastUpdate))$TotalCases-
(MainDataset %>% filter(ADM0NAME==Country,DateReport==LastUpdate-Days))$TotalCases))}
else {
Cases<-NA
}
return(Cases)
}
TableCases<-data.frame()
for (ctr in unique(MainDataset$ADM0NAME)){
Cases_7Days<-NbCases_Days(ctr,7)
vector<-data.frame(ctr,Cases_7Days)
TableCases<-bind_rows(vector,TableCases)
}
Incidence<-function(country,incidence,delay){
LastUpdate<-(Dataset_LastReportingDate %>% filter(ADM0NAME==country))$LastUpdate
if (CurrentDate-LastUpdate<=3){
Pop<-(Dataset_GlobalPopulation %>% filter(ADM0NAME==country))$Population
Incidence<-round(((MainDataset %>% filter(ADM0NAME==country) %>% filter(DateReport==LastUpdate-delay))$TotalCases-
(MainDataset %>% filter(ADM0NAME==country) %>% filter(DateReport==LastUpdate-incidence-delay))$TotalCases)/Pop*100000,1)}
else {
Incidence<-NA
}
return(Incidence)
}
TableIncidences<-data.frame()
for (ctr in unique(MainDataset$ADM0NAME)){
FrtDaysIncidence_Latest<-Incidence(ctr,14,0)
FrtDaysIncidence_1WkEarlier<-Incidence(ctr,14,7)
FrtDaysIncidence_2WkEarlier<-Incidence(ctr,14,14)
SvnDaysIncidence_Latest<-Incidence(ctr,7,0)
SvnDaysIncidence_1WkEarlier<-Incidence(ctr,7,7)
SvnDaysIncidence_2WkEarlier<-Incidence(ctr,7,14)
vector<-data.frame(ctr,
FrtDaysIncidence_Latest,
FrtDaysIncidence_1WkEarlier,
FrtDaysIncidence_2WkEarlier,
SvnDaysIncidence_Latest,
SvnDaysIncidence_1WkEarlier,
SvnDaysIncidence_2WkEarlier
)
TableIncidences<-bind_rows(vector,TableIncidences)
}
TableIncidences<-TableIncidences %>%
mutate(Change14DaysIncidence_2Weeks=round(FrtDaysIncidence_Latest/FrtDaysIncidence_2WkEarlier*100-100,1)) %>%
mutate(Change7DaysIncidence_1week=round(SvnDaysIncidence_Latest/SvnDaysIncidence_1WkEarlier*100-100,1))
SummaryTable_AllCountries<- MainDataset %>% filter(DateReport==CurrentDate) %>%
select(ADM0NAME,TotalCases,TotalDeaths,TransmissionStatus,RO,Trend,Population) %>%
left_join(TableIncidences,by=c('ADM0NAME'='ctr')) %>%
left_join(TableCases,by=c('ADM0NAME'='ctr')) %>%
mutate(CumulativeIncidence=round(TotalCases/Population*100000,1)) %>%
mutate(RateDeaths=round(TotalDeaths/Population*1000000,1))
View(SummaryTable_AllCountries)
shiny::runApp('GitHub/euro_covid_app/aggregate-app')
dataset<-read.csv('C:/Users/romanc/Desktop/qry_COVID_cases_by_date_final.CSV')
library(SummaryTable)
SummaryTable(dataset)
SummaryT<-SummaryTable(dataset)
View(SummaryT)
library(ChartCaseIncidenceCDC)
setwd(dirname(dirname(rstudioapi::getActiveDocumentContext()$path)))
WHO_ref<-read.csv('C:/Users/romanc/Documents/GitHub/Packages/ref_Country.csv')
ctr<-'Czech Republic'
CountryDataset<-BuildExtendedEpiDataset(ctr) %>%
mutate(DailyRate=NewCases/UNPOP2019*100000) %>%
select(ADM0NAME,
DateReport,
UNPOP2019,
TotalCases,
NewCases,
DailyRate,
ThreeDaysAverage_Cases,
ThreeDaysAverage_Cases_Rate)
CountryDataset<-CountryDataset %>%
mutate(CasesLast2Weeks = order_by(DateReport, TotalCases - lag(TotalCases,14)),
TwoWeekIncidence=CasesLast2Weeks/UNPOP2019*100000)
CountryDataset<-CountryDataset %>%  filter(!is.na(ThreeDaysAverage_Cases_Rate))
Spline3DaysAverage_Rate<-smooth.spline(x=CountryDataset$DateReport,
y=CountryDataset$ThreeDaysAverage_Cases_Rate,
spar=0.5)
ValuesSpline3DaysAverage_Rate<-data.frame(predict(Spline3DaysAverage_Rate,deriv=0),
predict(Spline3DaysAverage_Rate,deriv=1)) %>%
rename(Spline3DaysAverage_Rate=y,Slope3DaysAverage_Rate=y.1) %>% select(-c(x,x.1))
CountryDataset <- data.frame(CountryDataset,ValuesSpline3DaysAverage_Rate)
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(Slope3DaysAverage_Rate < 0)) %>%
mutate(NbDaysSlopeDecreasing = if_else(Slope3DaysAverage_Rate < 0, row_number(), 0L))
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(Slope3DaysAverage_Rate >= 0)) %>%
mutate(NbDaysSlopeIncreasing = if_else(Slope3DaysAverage_Rate>= 0, row_number(), 0L))
CountryDataset<-CountryDataset %>%
mutate(EpidemicStatusCurve=
case_when((TwoWeekIncidence<=10 & Slope3DaysAverage_Rate>=0.1) ~ "Low Incidence Growth",
(TwoWeekIncidence>10 & Slope3DaysAverage_Rate>=0.1) ~ "Elevated Incidence Growth",
(TwoWeekIncidence>10 & ((Slope3DaysAverage_Rate>=0 & Slope3DaysAverage_Rate <0.1)|(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing<=5)))~ "Elevated Incidence Plateau",
(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing>5) ~ "Sustained Decline",
(TwoWeekIncidence<=10 & ((Slope3DaysAverage_Rate>=0 & Slope3DaysAverage_Rate<0.1)|(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing<=5)))~ "Low Incidence Plateau"))
CountryDataset$EpidemicStatusCurve<-factor(CountryDataset$EpidemicStatusCurve, levels = c("Low Incidence Plateau","Low Incidence Growth","Elevated Incidence Growth","Elevated Incidence Plateau","Sustained Decline"))
plot<-ggplot(CountryDataset)+
geom_bar(aes(x=DateReport,y=DailyRate,fill=EpidemicStatusCurve),stat="identity")+
scale_fill_manual("Epidemic Curve Status",
breaks = c("Low Incidence Plateau","Low Incidence Growth","Elevated Incidence Growth","Elevated Incidence Plateau","Sustained Decline"),
values=c("#076769","#E47961","#751232","#C65154","#3EA8A6"),drop=FALSE)+
scale_color_manual(name=NULL,breaks=c('Spline'),labels=c('Spline built on 3-days average \ndaily incidence \n(smoothing parameter = 0.5)'),values=c('black'))+
scale_x_date(date_labels = "%d-%m",date_breaks = "15 days")+
geom_line(aes(x=DateReport,y=Spline3DaysAverage_Rate,color="Spline"),linetype=1,size=0.5)+
theme(legend.title = element_blank(),legend.text = element_text(size=10),legend.key.size=unit(0.2,"cm"),
plot.title = element_text(size = 10, face = "bold"),axis.title.y = element_text(size=8))+
labs(x='Date of report',y='Daily Incidence Rate \n (per 100,000 population)')
plot
View(CountryDataset)
