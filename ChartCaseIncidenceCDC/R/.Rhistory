predict(Spline3DaysAverage_Rate,deriv=1)) %>%
rename(Spline3DaysAverage_Rate=y,Slope3DaysAverage_Rate=y.1) %>% select(-c(x,x.1))
CountryDataset <- data.frame(CountryDataset,ValuesSpline3DaysAverage_Rate)
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(Slope3DaysAverage_Rate < 0)) %>%
mutate(NbDaysSlopeDecreasing = if_else(Slope3DaysAverage_Rate < 0, row_number(), 0L))
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(Slope3DaysAverage_Rate >= 0)) %>%
mutate(NbDaysSlopeIncreasing = if_else(Slope3DaysAverage_Rate>= 0, row_number(), 0L))
CountryDataset<-CountryDataset %>%
mutate(EpidemicStatusCurve=
case_when((TwoWeekIncidence<=10 & Slope3DaysAverage_Rate>=0.1) ~ "Low Incidence Growth",
(TwoWeekIncidence>10 & Slope3DaysAverage_Rate>=0.1) ~ "Elevated Incidence Growth",
(TwoWeekIncidence>10 & ((Slope3DaysAverage_Rate>=0 & Slope3DaysAverage_Rate <0.1)|(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing<=5)))~ "Elevated Incidence Plateau",
(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing>5) ~ "Sustained Decline",
(TwoWeekIncidence<=10 & ((Slope3DaysAverage_Rate>=0 & Slope3DaysAverage_Rate<0.1)|(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing<=5)))~ "Low Incidence Plateau"))
CountryDataset$EpidemicStatusCurve<-factor(CountryDataset$EpidemicStatusCurve, levels = c("Low Incidence Plateau","Low Incidence Growth","Elevated Incidence Growth","Elevated Incidence Plateau","Sustained Decline"))
plot<-ggplot(CountryDataset)+
geom_bar(aes(x=DateReport,y=DailyRate,fill=EpidemicStatusCurve),stat="identity")+
scale_fill_manual("Epidemic Curve Status",
breaks = c("Low Incidence Plateau","Low Incidence Growth","Elevated Incidence Growth","Elevated Incidence Plateau","Sustained Decline"),
values=c("#076769","#E47961","#751232","#C65154","#3EA8A6"),drop=FALSE)+
scale_color_manual(name=NULL,breaks=c('Spline'),labels=c('Spline built on 3-days average \ndaily incidence \n(smoothing parameter = 0.5)'),values=c('black'))+
scale_x_date(date_labels = "%d-%m",date_breaks = "15 days")+
geom_line(aes(x=DateReport,y=Spline3DaysAverage_Rate,color="Spline"),linetype=1,size=0.5)+
theme(legend.title = element_blank(),legend.text = element_text(size=10),legend.key.size=unit(0.2,"cm"),
plot.title = element_text(size = 10, face = "bold"),axis.title.y = element_text(size=8))+
labs(x='Date of report',y='Daily Incidence Rate \n (per 100,000 population)')
library(GetEpiData)
library(ggplot2)
WHO_ref<-WHO_ref %>%
select(ADM0NAME,UNPOP2019) %>%
mutate(ADM0NAME=str_to_title(ADM0NAME))
CountryDataset<-BuildExtendedEpiDataset(ctr) %>%
mutate(DailyRate=NewCases/UNPOP2019*100000) %>%
select(ADM0NAME,
DateReport,
UNPOP2019,
TotalCases,
NewCases,
DailyRate,
ThreeDaysAverage_Cases,
ThreeDaysAverage_Cases_Rate)
CountryDataset<-CountryDataset %>%
mutate(CasesLast2Weeks = order_by(DateReport, TotalCases - lag(TotalCases,14)),
TwoWeekIncidence=CasesLast2Weeks/UNPOP2019*100000)
CountryDataset<-CountryDataset %>%  filter(!is.na(ThreeDaysAverage_Cases_Rate))
Spline3DaysAverage_Rate<-smooth.spline(x=CountryDataset$DateReport,
y=CountryDataset$ThreeDaysAverage_Cases_Rate,
spar=0.5)
ValuesSpline3DaysAverage_Rate<-data.frame(predict(Spline3DaysAverage_Rate,deriv=0),
predict(Spline3DaysAverage_Rate,deriv=1)) %>%
rename(Spline3DaysAverage_Rate=y,Slope3DaysAverage_Rate=y.1) %>% select(-c(x,x.1))
CountryDataset <- data.frame(CountryDataset,ValuesSpline3DaysAverage_Rate)
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(Slope3DaysAverage_Rate < 0)) %>%
mutate(NbDaysSlopeDecreasing = if_else(Slope3DaysAverage_Rate < 0, row_number(), 0L))
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(Slope3DaysAverage_Rate >= 0)) %>%
mutate(NbDaysSlopeIncreasing = if_else(Slope3DaysAverage_Rate>= 0, row_number(), 0L))
CountryDataset<-CountryDataset %>%
mutate(EpidemicStatusCurve=
case_when((TwoWeekIncidence<=10 & Slope3DaysAverage_Rate>=0.1) ~ "Low Incidence Growth",
(TwoWeekIncidence>10 & Slope3DaysAverage_Rate>=0.1) ~ "Elevated Incidence Growth",
(TwoWeekIncidence>10 & ((Slope3DaysAverage_Rate>=0 & Slope3DaysAverage_Rate <0.1)|(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing<=5)))~ "Elevated Incidence Plateau",
(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing>5) ~ "Sustained Decline",
(TwoWeekIncidence<=10 & ((Slope3DaysAverage_Rate>=0 & Slope3DaysAverage_Rate<0.1)|(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing<=5)))~ "Low Incidence Plateau"))
CountryDataset$EpidemicStatusCurve<-factor(CountryDataset$EpidemicStatusCurve, levels = c("Low Incidence Plateau","Low Incidence Growth","Elevated Incidence Growth","Elevated Incidence Plateau","Sustained Decline"))
plot<-ggplot(CountryDataset)+
geom_bar(aes(x=DateReport,y=DailyRate,fill=EpidemicStatusCurve),stat="identity")+
scale_fill_manual("Epidemic Curve Status",
breaks = c("Low Incidence Plateau","Low Incidence Growth","Elevated Incidence Growth","Elevated Incidence Plateau","Sustained Decline"),
values=c("#076769","#E47961","#751232","#C65154","#3EA8A6"),drop=FALSE)+
scale_color_manual(name=NULL,breaks=c('Spline'),labels=c('Spline built on 3-days average \ndaily incidence \n(smoothing parameter = 0.5)'),values=c('black'))+
scale_x_date(date_labels = "%d-%m",date_breaks = "15 days")+
geom_line(aes(x=DateReport,y=Spline3DaysAverage_Rate,color="Spline"),linetype=1,size=0.5)+
theme(legend.title = element_blank(),legend.text = element_text(size=10),legend.key.size=unit(0.2,"cm"),
plot.title = element_text(size = 10, face = "bold"),axis.title.y = element_text(size=8))+
labs(x='Date of report',y='Daily Incidence Rate \n (per 100,000 population)')
library(BuildExtendedEpiDataset)
WHO_ref<-WHO_ref %>%
select(ADM0NAME,UNPOP2019) %>%
mutate(ADM0NAME=str_to_title(ADM0NAME))
CountryDataset<-BuildExtendedEpiDataset(ctr) %>%
mutate(DailyRate=NewCases/UNPOP2019*100000) %>%
select(ADM0NAME,
DateReport,
UNPOP2019,
TotalCases,
NewCases,
DailyRate,
ThreeDaysAverage_Cases,
ThreeDaysAverage_Cases_Rate)
CountryDataset<-CountryDataset %>%
mutate(CasesLast2Weeks = order_by(DateReport, TotalCases - lag(TotalCases,14)),
TwoWeekIncidence=CasesLast2Weeks/UNPOP2019*100000)
CountryDataset<-CountryDataset %>%  filter(!is.na(ThreeDaysAverage_Cases_Rate))
Spline3DaysAverage_Rate<-smooth.spline(x=CountryDataset$DateReport,
y=CountryDataset$ThreeDaysAverage_Cases_Rate,
spar=0.5)
ValuesSpline3DaysAverage_Rate<-data.frame(predict(Spline3DaysAverage_Rate,deriv=0),
predict(Spline3DaysAverage_Rate,deriv=1)) %>%
rename(Spline3DaysAverage_Rate=y,Slope3DaysAverage_Rate=y.1) %>% select(-c(x,x.1))
CountryDataset <- data.frame(CountryDataset,ValuesSpline3DaysAverage_Rate)
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(Slope3DaysAverage_Rate < 0)) %>%
mutate(NbDaysSlopeDecreasing = if_else(Slope3DaysAverage_Rate < 0, row_number(), 0L))
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(Slope3DaysAverage_Rate >= 0)) %>%
mutate(NbDaysSlopeIncreasing = if_else(Slope3DaysAverage_Rate>= 0, row_number(), 0L))
CountryDataset<-CountryDataset %>%
mutate(EpidemicStatusCurve=
case_when((TwoWeekIncidence<=10 & Slope3DaysAverage_Rate>=0.1) ~ "Low Incidence Growth",
(TwoWeekIncidence>10 & Slope3DaysAverage_Rate>=0.1) ~ "Elevated Incidence Growth",
(TwoWeekIncidence>10 & ((Slope3DaysAverage_Rate>=0 & Slope3DaysAverage_Rate <0.1)|(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing<=5)))~ "Elevated Incidence Plateau",
(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing>5) ~ "Sustained Decline",
(TwoWeekIncidence<=10 & ((Slope3DaysAverage_Rate>=0 & Slope3DaysAverage_Rate<0.1)|(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing<=5)))~ "Low Incidence Plateau"))
CountryDataset$EpidemicStatusCurve<-factor(CountryDataset$EpidemicStatusCurve, levels = c("Low Incidence Plateau","Low Incidence Growth","Elevated Incidence Growth","Elevated Incidence Plateau","Sustained Decline"))
plot<-ggplot(CountryDataset)+
geom_bar(aes(x=DateReport,y=DailyRate,fill=EpidemicStatusCurve),stat="identity")+
scale_fill_manual("Epidemic Curve Status",
breaks = c("Low Incidence Plateau","Low Incidence Growth","Elevated Incidence Growth","Elevated Incidence Plateau","Sustained Decline"),
values=c("#076769","#E47961","#751232","#C65154","#3EA8A6"),drop=FALSE)+
scale_color_manual(name=NULL,breaks=c('Spline'),labels=c('Spline built on 3-days average \ndaily incidence \n(smoothing parameter = 0.5)'),values=c('black'))+
scale_x_date(date_labels = "%d-%m",date_breaks = "15 days")+
geom_line(aes(x=DateReport,y=Spline3DaysAverage_Rate,color="Spline"),linetype=1,size=0.5)+
theme(legend.title = element_blank(),legend.text = element_text(size=10),legend.key.size=unit(0.2,"cm"),
plot.title = element_text(size = 10, face = "bold"),axis.title.y = element_text(size=8))+
labs(x='Date of report',y='Daily Incidence Rate \n (per 100,000 population)')
ctr
CountryDataset<-BuildExtendedEpiDataset(ctr) %>%
mutate(DailyRate=NewCases/UNPOP2019*100000) %>%
select(ADM0NAME,
DateReport,
UNPOP2019,
TotalCases,
NewCases,
DailyRate,
ThreeDaysAverage_Cases,
ThreeDaysAverage_Cases_Rate)
CountryDataset<-CountryDataset %>%
mutate(CasesLast2Weeks = order_by(DateReport, TotalCases - lag(TotalCases,14)),
TwoWeekIncidence=CasesLast2Weeks/UNPOP2019*100000)
CountryDataset<-CountryDataset %>%  filter(!is.na(ThreeDaysAverage_Cases_Rate))
Spline3DaysAverage_Rate<-smooth.spline(x=CountryDataset$DateReport,
y=CountryDataset$ThreeDaysAverage_Cases_Rate,
spar=0.5)
ValuesSpline3DaysAverage_Rate<-data.frame(predict(Spline3DaysAverage_Rate,deriv=0),
predict(Spline3DaysAverage_Rate,deriv=1)) %>%
rename(Spline3DaysAverage_Rate=y,Slope3DaysAverage_Rate=y.1) %>% select(-c(x,x.1))
CountryDataset <- data.frame(CountryDataset,ValuesSpline3DaysAverage_Rate)
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(Slope3DaysAverage_Rate < 0)) %>%
mutate(NbDaysSlopeDecreasing = if_else(Slope3DaysAverage_Rate < 0, row_number(), 0L))
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(Slope3DaysAverage_Rate >= 0)) %>%
mutate(NbDaysSlopeIncreasing = if_else(Slope3DaysAverage_Rate>= 0, row_number(), 0L))
CountryDataset<-CountryDataset %>%
mutate(EpidemicStatusCurve=
case_when((TwoWeekIncidence<=10 & Slope3DaysAverage_Rate>=0.1) ~ "Low Incidence Growth",
(TwoWeekIncidence>10 & Slope3DaysAverage_Rate>=0.1) ~ "Elevated Incidence Growth",
(TwoWeekIncidence>10 & ((Slope3DaysAverage_Rate>=0 & Slope3DaysAverage_Rate <0.1)|(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing<=5)))~ "Elevated Incidence Plateau",
(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing>5) ~ "Sustained Decline",
(TwoWeekIncidence<=10 & ((Slope3DaysAverage_Rate>=0 & Slope3DaysAverage_Rate<0.1)|(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing<=5)))~ "Low Incidence Plateau"))
CountryDataset$EpidemicStatusCurve<-factor(CountryDataset$EpidemicStatusCurve, levels = c("Low Incidence Plateau","Low Incidence Growth","Elevated Incidence Growth","Elevated Incidence Plateau","Sustained Decline"))
plot<-ggplot(CountryDataset)+
geom_bar(aes(x=DateReport,y=DailyRate,fill=EpidemicStatusCurve),stat="identity")+
scale_fill_manual("Epidemic Curve Status",
breaks = c("Low Incidence Plateau","Low Incidence Growth","Elevated Incidence Growth","Elevated Incidence Plateau","Sustained Decline"),
values=c("#076769","#E47961","#751232","#C65154","#3EA8A6"),drop=FALSE)+
scale_color_manual(name=NULL,breaks=c('Spline'),labels=c('Spline built on 3-days average \ndaily incidence \n(smoothing parameter = 0.5)'),values=c('black'))+
scale_x_date(date_labels = "%d-%m",date_breaks = "15 days")+
geom_line(aes(x=DateReport,y=Spline3DaysAverage_Rate,color="Spline"),linetype=1,size=0.5)+
theme(legend.title = element_blank(),legend.text = element_text(size=10),legend.key.size=unit(0.2,"cm"),
plot.title = element_text(size = 10, face = "bold"),axis.title.y = element_text(size=8))+
labs(x='Date of report',y='Daily Incidence Rate \n (per 100,000 population)')
plot
View(CountryDataset)
rm(list = ls())
PackagesToInstall<-c('ISOweek',"hablar","ggsci","stringr","magick","gridExtra","lubridate","readxl","RColorBrewer","ggplot2","dplyr","rmarkdown","kableExtra","flextable","ggpubr","knitr","scales","tidyr","scales","xml2","rvest","qdapRegex",'cowplot')
for (i in PackagesToInstall) {
print(i)
if (!i %in% installed.packages())
{install.packages(i)}
library(i, character.only = TRUE)
}
### To update manually
# reporting.week <- str_replace(ISOweek(Sys.Date() - 6), "W", "")
# previous.week <- str_replace(ISOweek(Sys.Date() - 13), "W", "")
# previous.previous.week<-str_replace(ISOweek(Sys.Date() - 20), "W", "")
#
# reporting.week_<-ISOweek(Sys.Date() - 6)
# previous.week_<-ISOweek(Sys.Date() - 13)
reporting.week <- "2021-18" #manually enter
previous.week <- "2021-17"
previous.previous.week<-"2021-16"
reporting.week_ <- "2021-W18" #manually enter
previous.week_ <- "2021-W17"
StartDate <- ISOweek2date(paste(reporting.week_,1, sep="-"))
EndDate <- ISOweek2date(paste(reporting.week_,7, sep="-"))
###
folder<-dirname(rstudioapi::getSourceEditorContext()$path)
folder<-dirname(dirname(folder)) # move two dirs above HIM
folder<-paste0(folder,'/InOutTransStatus') # change to In Out folder
PopulationData<-read.csv(paste0(folder,'/ref_Country.csv')) %>%
mutate(ADM0NAME=str_to_title(ADM0NAME)) %>%
select(ADM0NAME,UNPOP2019)
WHO_Codes<-read.csv(paste0(folder,'/ref_Country.csv')) %>%
mutate(ADM0NAME=str_to_title(ADM0NAME)) %>%
select(ADM0NAME,WHO_CODE)
MainDataset_Current<-read.csv(paste0(folder,'/qry_COVID_running_cases_country_date.csv')) %>%
mutate(ADM0NAME=str_to_title(ADM0NAME)) %>%
filter(DateReport1 <= EndDate, DateReport1 >= StartDate) %>%
group_by(ADM0NAME) %>%
summarise(WeekCases=sum(NewCases),
WeekDeaths=sum(NewDeaths))
MainDataset_OneWeekBefore<-read.csv(paste0(folder,'/qry_COVID_running_cases_country_date.csv')) %>%
mutate(ADM0NAME=str_to_title(ADM0NAME)) %>%
filter(DateReport1 <= EndDate-7, DateReport1 >= StartDate-7) %>%
group_by(ADM0NAME) %>%
summarise(WeekBefore_Cases=sum(NewCases),
WeekBefore_Deaths=sum(NewDeaths))
MainDataset<-MainDataset_Current %>%
left_join(MainDataset_OneWeekBefore,by='ADM0NAME') %>%
mutate(MeanCases2Weeks=(WeekCases+WeekBefore_Cases)/2,
MeanDeaths2Weeks=(WeekDeaths+WeekBefore_Deaths)/2) %>%
left_join(PopulationData,by='ADM0NAME') %>%
mutate(mort_rate_IHR=MeanDeaths2Weeks/UNPOP2019*100000,case_inc_IHR=MeanCases2Weeks/UNPOP2019*100000)
#Step 1A - Read TessyDataset, doesn't take all columns since classifications might change after filling the gaps
TessyDataset<-read_excel(paste0(folder,'/',reporting.week,'_Tessy.xlsx')) %>%
mutate(country=str_to_title(country)) %>%
select(country,hosp_rate,positivity,icu_rate,mort_rate,case_inc) %>%
mutate(country=if_else(country=='Czechia','Czech Republic',country),
country=if_else(country=='Kosovo (In Accordance With Security Council Resolution 1244 (1999))','Kosovo',country)) %>%
mutate(hosp_rate=as.numeric(hosp_rate),
positivity=as.numeric(positivity),
icu_rate=as.numeric(icu_rate),
mort_rate=as.numeric(mort_rate),
case_inc=as.numeric(case_inc))
View(TessyDataset)
ECDCDataset_Hosp<-read_excel(paste0(folder,'/',reporting.week,'_ECDC_HospICU.xlsx'),.name_repair = "universal") %>%
mutate(country=if_else(country=='Czechia','Czech Republic',country)) %>%
filter(year_week==reporting.week_| year_week==previous.week_,indicator=='Daily hospital occupancy') %>%
group_by(country) %>%
summarise(Weekly_Average_hosp=mean(value)) %>%
left_join(PopulationData,by=c('country'='ADM0NAME')) %>%
mutate(Hosp_occ=Weekly_Average_hosp/UNPOP2019*100000)
ECDCDataset_HospRate<-read_excel(paste0(folder,'/',reporting.week,'_ECDC_HospICU.xlsx'),.name_repair = "universal") %>%
mutate(country=if_else(country=='Czechia','Czech Republic',country)) %>%
filter(year_week==reporting.week_| year_week==previous.week_,indicator=='Weekly new hospital admissions per 100k') %>%
group_by(country) %>% summarise(ECDC_hosp_rate=mean(value))
ECDCDataset_ICU<-read_excel(paste0(folder,'/',reporting.week,'_ECDC_HospICU.xlsx'),.name_repair = "universal") %>%
mutate(country=if_else(country=='Czechia','Czech Republic',country)) %>%
filter(year_week==reporting.week_| year_week==previous.week_,indicator=='Daily ICU occupancy') %>%
group_by(country) %>%
summarise(Weekly_Average_ICU=mean(value)) %>%
left_join(PopulationData,by=c('country'='ADM0NAME')) %>%
mutate(ICU_occ=Weekly_Average_ICU/UNPOP2019*100000)
ECDCDataset_ICURate<-read_excel(paste0(folder,'/',reporting.week,'_ECDC_HospICU.xlsx'),.name_repair = "universal") %>%
mutate(country=if_else(country=='Czechia','Czech Republic',country)) %>%
filter(year_week==reporting.week_| year_week==previous.week_,indicator=='Weekly new ICU admissions per 100k') %>%
group_by(country) %>% summarise(ECDC_ICU_rate=mean(value))
ECDCDataset<-ECDCDataset_Testing %>%
left_join(ECDCDataset_Hosp,by='country') %>%
left_join(ECDCDataset_HospRate) %>%
left_join(ECDCDataset_ICU,by='country') %>%
left_join(ECDCDataset_ICURate,by='country') %>%
select(country,ECDC_positivity=positivity,ECDC_hosp_rate,ECDC_ICU_rate,Hosp_occ,ICU_occ)
View(ECDCDataset_Hosp)
CountryDataset<-BuildExtendedEpiDataset(country) %>%
select(ADM0NAME,DateReport,NewDeaths,NewDeaths_Rate,UNPOP2019,ThreeDaysAverage_Deaths_Rate)
CountryDataset <- CountryDataset %>% drop_na()
minDate<-min(CountryDataset$DateReport)
maxDate<-max(CountryDataset$DateReport)
Spline3DaysAverage<-smooth.spline(x=CountryDataset$DateReport,y=CountryDataset$ThreeDaysAverage_Deaths_Rate,spar=0.5)
ValuesSpline3DaysAverage<-data.frame(predict(Spline3DaysAverage,deriv=0),predict(Spline3DaysAverage,deriv=1)) %>%
rename(Spline3DaysAverage=y,Slope3DaysAverage=y.1) %>% select(-c(x,x.1))
CountryDataset <- data.frame(CountryDataset,ValuesSpline3DaysAverage)
CountryDataset<-CountryDataset %>%
mutate(SlopeClassification=if_else(Slope3DaysAverage<=0,"Decline","Increase"))
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(SlopeClassification == 'Decline')) %>%
mutate(DaysDecline = if_else(SlopeClassification == 'Decline', row_number(), 0L))
CountryDataset<- CountryDataset %>%
mutate(Indicator=if_else(DaysDecline==0,"",
if_else(DaysDecline>=21,
"Daily rate of deaths is declining since more than 3 weeks",
"Daily rate of deaths is declining")))
CountryDataset$Indicator<-factor(CountryDataset$Indicator,
levels = c("","Daily rate of deaths is declining",
"Daily rate of deaths is declining since more than 3 weeks"))
plot<-ggplot(CountryDataset)+
geom_bar(aes(x=DateReport,y=NewDeaths_Rate,fill=Indicator),stat="identity")+
geom_line(aes(x=DateReport,y=Spline3DaysAverage,color='Spline'))+
scale_fill_manual(name=NULL,values=c("#C65154","#BBE4D1","#3EA8A6"),
breaks=c("","Daily rate of deaths is declining","Daily rate of deaths is declining since more than 3 weeks"),
labels=c("Increase","Continuous decline","Continuous decline for \nmore than 3 weeks"),drop=FALSE)+
scale_color_manual(name=NULL,breaks=c('Spline'),labels=c('Spline built on 3-days average \ndaily deaths rate \n(smoothing parameter = 0.5)'),values=c('black'))+
scale_x_date(date_labels = "%d-%m",date_breaks = "30 days",limits=c(minDate,maxDate))+
labs(y="Daily Deaths Rate \n (per 1.000.000 population)",x='Date of report')+
guides(colour = guide_legend(order = 2),
fill = guide_legend(order = 1))+
theme(legend.title = element_blank(),legend.text = element_text(size=10),legend.key.size=unit(0.2,"cm"),
plot.title = element_text(size = 10, face = "bold"),axis.title.y = element_text(size=8))
plot<-plot_grid(plot+theme(legend.position="none"),get_legend(plot),ncol=2,rel_widths=c(8,2),align="vh")
CountryDataset<-BuildExtendedEpiDataset(country) %>%
select(ADM0NAME,DateReport,NewDeaths,NewDeaths_Rate,UNPOP2019,ThreeDaysAverage_Deaths_Rate)
CountryDataset<-BuildExtendedEpiDataset(country) %>%
select(ADM0NAME,DateReport,NewDeaths,NewDeaths_Rate,UNPOP2019,ThreeDaysAverage_Deaths_Rate)
country
country<-'Latvia'
CountryDataset<-BuildExtendedEpiDataset(country) %>%
select(ADM0NAME,DateReport,NewDeaths,NewDeaths_Rate,UNPOP2019,ThreeDaysAverage_Deaths_Rate)
CountryDataset <- CountryDataset %>% drop_na()
minDate<-min(CountryDataset$DateReport)
maxDate<-max(CountryDataset$DateReport)
Spline3DaysAverage<-smooth.spline(x=CountryDataset$DateReport,y=CountryDataset$ThreeDaysAverage_Deaths_Rate,spar=0.5)
ValuesSpline3DaysAverage<-data.frame(predict(Spline3DaysAverage,deriv=0),predict(Spline3DaysAverage,deriv=1)) %>%
rename(Spline3DaysAverage=y,Slope3DaysAverage=y.1) %>% select(-c(x,x.1))
CountryDataset <- data.frame(CountryDataset,ValuesSpline3DaysAverage)
CountryDataset<-CountryDataset %>%
mutate(SlopeClassification=if_else(Slope3DaysAverage<=0,"Decline","Increase"))
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(SlopeClassification == 'Decline')) %>%
mutate(DaysDecline = if_else(SlopeClassification == 'Decline', row_number(), 0L))
CountryDataset<- CountryDataset %>%
mutate(Indicator=if_else(DaysDecline==0,"",
if_else(DaysDecline>=21,
"Daily rate of deaths is declining since more than 3 weeks",
"Daily rate of deaths is declining")))
CountryDataset$Indicator<-factor(CountryDataset$Indicator,
levels = c("","Daily rate of deaths is declining",
"Daily rate of deaths is declining since more than 3 weeks"))
plot<-ggplot(CountryDataset)+
geom_bar(aes(x=DateReport,y=NewDeaths_Rate,fill=Indicator),stat="identity")+
geom_line(aes(x=DateReport,y=Spline3DaysAverage,color='Spline'))+
scale_fill_manual(name=NULL,values=c("#C65154","#BBE4D1","#3EA8A6"),
breaks=c("","Daily rate of deaths is declining","Daily rate of deaths is declining since more than 3 weeks"),
labels=c("Increase","Continuous decline","Continuous decline for \nmore than 3 weeks"),drop=FALSE)+
scale_color_manual(name=NULL,breaks=c('Spline'),labels=c('Spline built on 3-days average \ndaily deaths rate \n(smoothing parameter = 0.5)'),values=c('black'))+
scale_x_date(date_labels = "%d-%m",date_breaks = "30 days",limits=c(minDate,maxDate))+
labs(y="Daily Deaths Rate \n (per 1.000.000 population)",x='Date of report')+
guides(colour = guide_legend(order = 2),
fill = guide_legend(order = 1))+
theme(legend.title = element_blank(),legend.text = element_text(size=10),legend.key.size=unit(0.2,"cm"),
plot.title = element_text(size = 10, face = "bold"),axis.title.y = element_text(size=8))
plot<-plot_grid(plot+theme(legend.position="none"),get_legend(plot),ncol=2,rel_widths=c(8,2),align="vh")
View(plot)
plot
View(CountryDataset)
View(CountryDataset)
ctr<-'France'
country<-'France'
WHO_ref<-WHO_ref %>%
select(ADM0NAME,UNPOP2019) %>%
mutate(ADM0NAME=str_to_title(ADM0NAME))
CountryDataset<-BuildExtendedEpiDataset(ctr) %>%
mutate(DailyRate=NewCases/UNPOP2019*100000) %>%
select(ADM0NAME,
DateReport,
UNPOP2019,
TotalCases,
NewCases,
DailyRate,
ThreeDaysAverage_Cases,
ThreeDaysAverage_Cases_Rate)
CountryDataset<-CountryDataset %>%
mutate(CasesLast2Weeks = order_by(DateReport, TotalCases - lag(TotalCases,14)),
TwoWeekIncidence=CasesLast2Weeks/UNPOP2019*100000)
CountryDataset<-CountryDataset %>%  filter(!is.na(ThreeDaysAverage_Cases_Rate))
Spline3DaysAverage_Rate<-smooth.spline(x=CountryDataset$DateReport,
y=CountryDataset$ThreeDaysAverage_Cases_Rate,
spar=0.5)
ValuesSpline3DaysAverage_Rate<-data.frame(predict(Spline3DaysAverage_Rate,deriv=0),
predict(Spline3DaysAverage_Rate,deriv=1)) %>%
rename(Spline3DaysAverage_Rate=y,Slope3DaysAverage_Rate=y.1) %>% select(-c(x,x.1))
CountryDataset <- data.frame(CountryDataset,ValuesSpline3DaysAverage_Rate)
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(Slope3DaysAverage_Rate < 0)) %>%
mutate(NbDaysSlopeDecreasing = if_else(Slope3DaysAverage_Rate < 0, row_number(), 0L))
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(Slope3DaysAverage_Rate >= 0)) %>%
mutate(NbDaysSlopeIncreasing = if_else(Slope3DaysAverage_Rate>= 0, row_number(), 0L))
CountryDataset<-CountryDataset %>%
mutate(EpidemicStatusCurve=
case_when((TwoWeekIncidence<=10 & Slope3DaysAverage_Rate>=0.1) ~ "Low Incidence Growth",
(TwoWeekIncidence>10 & Slope3DaysAverage_Rate>=0.1) ~ "Elevated Incidence Growth",
(TwoWeekIncidence>10 & ((Slope3DaysAverage_Rate>=0 & Slope3DaysAverage_Rate <0.1)|(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing<=5)))~ "Elevated Incidence Plateau",
(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing>5) ~ "Sustained Decline",
(TwoWeekIncidence<=10 & ((Slope3DaysAverage_Rate>=0 & Slope3DaysAverage_Rate<0.1)|(Slope3DaysAverage_Rate<0 & NbDaysSlopeDecreasing<=5)))~ "Low Incidence Plateau"))
CountryDataset$EpidemicStatusCurve<-factor(CountryDataset$EpidemicStatusCurve, levels = c("Low Incidence Plateau","Low Incidence Growth","Elevated Incidence Growth","Elevated Incidence Plateau","Sustained Decline"))
plot<-ggplot(CountryDataset)+
geom_bar(aes(x=DateReport,y=DailyRate,fill=EpidemicStatusCurve),stat="identity")+
scale_fill_manual("Epidemic Curve Status",
breaks = c("Low Incidence Plateau","Low Incidence Growth","Elevated Incidence Growth","Elevated Incidence Plateau","Sustained Decline"),
values=c("#076769","#E47961","#751232","#C65154","#3EA8A6"),drop=FALSE)+
scale_color_manual(name=NULL,breaks=c('Spline'),labels=c('Spline built on 3-days average \ndaily incidence \n(smoothing parameter = 0.5)'),values=c('black'))+
scale_x_date(date_labels = "%d-%m",date_breaks = "15 days")+
geom_line(aes(x=DateReport,y=Spline3DaysAverage_Rate,color="Spline"),linetype=1,size=0.5)+
theme(legend.title = element_blank(),legend.text = element_text(size=10),legend.key.size=unit(0.2,"cm"),
plot.title = element_text(size = 10, face = "bold"),axis.title.y = element_text(size=8))+
labs(x='Date of report',y='Daily Incidence Rate \n (per 100,000 population)')
CountryDataset
plot
plot
CountryDataset <- CountryDataset %>% drop_na()
minDate<-min(CountryDataset$DateReport)
maxDate<-max(CountryDataset$DateReport)
Spline3DaysAverage<-smooth.spline(x=CountryDataset$DateReport,y=CountryDataset$ThreeDaysAverage_Deaths_Rate,spar=0.5)
ValuesSpline3DaysAverage<-data.frame(predict(Spline3DaysAverage,deriv=0),predict(Spline3DaysAverage,deriv=1)) %>%
rename(Spline3DaysAverage=y,Slope3DaysAverage=y.1) %>% select(-c(x,x.1))
CountryDataset <- data.frame(CountryDataset,ValuesSpline3DaysAverage)
CountryDataset<-CountryDataset %>%
mutate(SlopeClassification=if_else(Slope3DaysAverage<=0,"Decline","Increase"))
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(SlopeClassification == 'Decline')) %>%
mutate(DaysDecline = if_else(SlopeClassification == 'Decline', row_number(), 0L))
CountryDataset<- CountryDataset %>%
mutate(Indicator=if_else(DaysDecline==0,"",
if_else(DaysDecline>=21,
"Daily rate of deaths is declining since more than 3 weeks",
"Daily rate of deaths is declining")))
CountryDataset$Indicator<-factor(CountryDataset$Indicator,
levels = c("","Daily rate of deaths is declining",
"Daily rate of deaths is declining since more than 3 weeks"))
plot<-ggplot(CountryDataset)+
geom_bar(aes(x=DateReport,y=NewDeaths_Rate,fill=Indicator),stat="identity")+
geom_line(aes(x=DateReport,y=Spline3DaysAverage,color='Spline'))+
scale_fill_manual(name=NULL,values=c("#C65154","#BBE4D1","#3EA8A6"),
breaks=c("","Daily rate of deaths is declining","Daily rate of deaths is declining since more than 3 weeks"),
labels=c("Increase","Continuous decline","Continuous decline for \nmore than 3 weeks"),drop=FALSE)+
scale_color_manual(name=NULL,breaks=c('Spline'),labels=c('Spline built on 3-days average \ndaily deaths rate \n(smoothing parameter = 0.5)'),values=c('black'))+
scale_x_date(date_labels = "%d-%m",date_breaks = "30 days",limits=c(minDate,maxDate))+
labs(y="Daily Deaths Rate \n (per 1.000.000 population)",x='Date of report')+
guides(colour = guide_legend(order = 2),
fill = guide_legend(order = 1))+
theme(legend.title = element_blank(),legend.text = element_text(size=10),legend.key.size=unit(0.2,"cm"),
plot.title = element_text(size = 10, face = "bold"),axis.title.y = element_text(size=8))
plot<-plot_grid(plot+theme(legend.position="none"),get_legend(plot),ncol=2,rel_widths=c(8,2),align="vh")
country<-'France'
CountryDataset<-BuildExtendedEpiDataset(country) %>%
select(ADM0NAME,DateReport,NewDeaths,NewDeaths_Rate,UNPOP2019,ThreeDaysAverage_Deaths_Rate)
CountryDataset <- CountryDataset %>% drop_na()
minDate<-min(CountryDataset$DateReport)
maxDate<-max(CountryDataset$DateReport)
Spline3DaysAverage<-smooth.spline(x=CountryDataset$DateReport,y=CountryDataset$ThreeDaysAverage_Deaths_Rate,spar=0.5)
ValuesSpline3DaysAverage<-data.frame(predict(Spline3DaysAverage,deriv=0),predict(Spline3DaysAverage,deriv=1)) %>%
rename(Spline3DaysAverage=y,Slope3DaysAverage=y.1) %>% select(-c(x,x.1))
CountryDataset <- data.frame(CountryDataset,ValuesSpline3DaysAverage)
CountryDataset<-CountryDataset %>%
mutate(SlopeClassification=if_else(Slope3DaysAverage<=0,"Decline","Increase"))
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(SlopeClassification == 'Decline')) %>%
mutate(DaysDecline = if_else(SlopeClassification == 'Decline', row_number(), 0L))
CountryDataset<- CountryDataset %>%
mutate(Indicator=if_else(DaysDecline==0,"",
if_else(DaysDecline>=21,
"Daily rate of deaths is declining since more than 3 weeks",
"Daily rate of deaths is declining")))
CountryDataset$Indicator<-factor(CountryDataset$Indicator,
levels = c("","Daily rate of deaths is declining",
"Daily rate of deaths is declining since more than 3 weeks"))
plot<-ggplot(CountryDataset)+
geom_bar(aes(x=DateReport,y=NewDeaths_Rate,fill=Indicator),stat="identity")+
geom_line(aes(x=DateReport,y=Spline3DaysAverage,color='Spline'))+
scale_fill_manual(name=NULL,values=c("#C65154","#BBE4D1","#3EA8A6"),
breaks=c("","Daily rate of deaths is declining","Daily rate of deaths is declining since more than 3 weeks"),
labels=c("Increase","Continuous decline","Continuous decline for \nmore than 3 weeks"),drop=FALSE)+
scale_color_manual(name=NULL,breaks=c('Spline'),labels=c('Spline built on 3-days average \ndaily deaths rate \n(smoothing parameter = 0.5)'),values=c('black'))+
scale_x_date(date_labels = "%d-%m",date_breaks = "30 days",limits=c(minDate,maxDate))+
labs(y="Daily Deaths Rate \n (per 1.000.000 population)",x='Date of report')+
guides(colour = guide_legend(order = 2),
fill = guide_legend(order = 1))+
theme(legend.title = element_blank(),legend.text = element_text(size=10),legend.key.size=unit(0.2,"cm"),
plot.title = element_text(size = 10, face = "bold"),axis.title.y = element_text(size=8))
plot<-plot_grid(plot+theme(legend.position="none"),get_legend(plot),ncol=2,rel_widths=c(8,2),align="vh")
CountryDataset<-BuildExtendedEpiDataset(country) %>%
select(ADM0NAME,DateReport,NewDeaths,NewDeaths_Rate,UNPOP2019,ThreeDaysAverage_Deaths_Rate)
CountryDataset <- CountryDataset %>% drop_na()
minDate<-min(CountryDataset$DateReport)
maxDate<-max(CountryDataset$DateReport)
Spline3DaysAverage<-smooth.spline(x=CountryDataset$DateReport,y=CountryDataset$ThreeDaysAverage_Deaths_Rate,spar=0.5)
ValuesSpline3DaysAverage<-data.frame(predict(Spline3DaysAverage,deriv=0),predict(Spline3DaysAverage,deriv=1)) %>%
rename(Spline3DaysAverage=y,Slope3DaysAverage=y.1) %>% select(-c(x,x.1))
CountryDataset <- data.frame(CountryDataset,ValuesSpline3DaysAverage)
CountryDataset<-CountryDataset %>%
mutate(SlopeClassification=if_else(Slope3DaysAverage<=0,"Decline","Increase"))
CountryDataset <-CountryDataset %>%
group_by(ID = data.table::rleid(SlopeClassification == 'Decline')) %>%
mutate(DaysDecline = if_else(SlopeClassification == 'Decline', row_number(), 0L))
CountryDataset<- CountryDataset %>%
mutate(Indicator=if_else(DaysDecline==0,"",
if_else(DaysDecline>=21,
"Daily rate of deaths is declining since more than 3 weeks",
"Daily rate of deaths is declining")))
CountryDataset$Indicator<-factor(CountryDataset$Indicator,
levels = c("","Daily rate of deaths is declining",
"Daily rate of deaths is declining since more than 3 weeks"))
plot<-ggplot(CountryDataset)+
geom_bar(aes(x=DateReport,y=NewDeaths_Rate,fill=Indicator),stat="identity")+
geom_line(aes(x=DateReport,y=Spline3DaysAverage,color='Spline'))+
scale_fill_manual(name=NULL,values=c("#C65154","#BBE4D1","#3EA8A6"),
breaks=c("","Daily rate of deaths is declining","Daily rate of deaths is declining since more than 3 weeks"),
labels=c("Increase","Continuous decline","Continuous decline for \nmore than 3 weeks"),drop=FALSE)+
scale_color_manual(name=NULL,breaks=c('Spline'),labels=c('Spline built on 3-days average \ndaily deaths rate \n(smoothing parameter = 0.5)'),values=c('black'))+
scale_x_date(date_labels = "%d-%m",date_breaks = "30 days",limits=c(minDate,maxDate))+
labs(y="Daily Deaths Rate \n (per 1.000.000 population)",x='Date of report')+
guides(colour = guide_legend(order = 2),
fill = guide_legend(order = 1))+
theme(legend.title = element_blank(),legend.text = element_text(size=10),legend.key.size=unit(0.2,"cm"),
plot.title = element_text(size = 10, face = "bold"),axis.title.y = element_text(size=8))
plot<-plot_grid(plot+theme(legend.position="none"),get_legend(plot),ncol=2,rel_widths=c(8,2),align="vh")
