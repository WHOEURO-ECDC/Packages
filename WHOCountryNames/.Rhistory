for (i in PackagesToInstall) {
print(i)
if (!i %in% installed.packages())
{install.packages(i)}
library(i, character.only = TRUE)
}
#### 1.B - Reads all datasets necessary for the script and do some adaptations, reformating or basic calculations ####
#Reads where the file 'ScriptToRun.R' is stored
folder_<-dirname(rstudioapi::getSourceEditorContext()$path)
folderOutGit<-dirname(dirname(folder_))
folder<-paste0(folderOutGit,'/InOutSlideDeck')
Dataset_Epiforecast_ <- read.csv("https://raw.githubusercontent.com/epiforecasts/covid-rt-estimates/master/national/cases/summary/rt.csv") %>%
filter(type=='estimate')
Dataset_GlobalPopulation<-read.csv(paste0(folder,"/NoUpdateNeeded/ref_Country.csv")) %>%
select(ADM0NAME,UNPOP2019) %>% mutate(ADM0NAME=str_to_title(ADM0NAME))
MainDataset<-read.csv(paste0(folder,"/ForDailyUpdate/qry_COVID_running_cases_country_date.csv")) %>%
mutate(DateReport1=as.Date(parse_date_time(DateReport1, c("dmy", "ymd","mdy"))),ADM0NAME=str_to_title(ADM0NAME)) %>%
left_join(Dataset_GlobalPopulation,by="ADM0NAME")
JRCDataset<-read.csv('https://raw.githubusercontent.com/ec-jrc/COVID-19/master/data-by-country/jrc-covid-19-all-days-by-country.csv') %>%
mutate(CountryName=if_else(CountryName=='Moldova','Republic Of Moldova',CountryName)) %>%
mutate(CountryName=str_to_title(CountryName))
ECDC_Hosp<-read_excel(paste0(folder,"/ForDailyUpdate/ECDC_HospICU.xlsx"))
Vaccines_Tracker<-read.csv(paste0(folder,'/ForDailyUpdate/data_for_mapping_vaccines.csv'))
HQTesting<-read_excel(paste0(folder,"/ForDailyUpdate/HQ_Testing.xlsx"))
tessy_epi<-read.csv(paste0(folder,"/ForDailyUpdate/tessy_aggregated.csv"))
View(tessy_epi)
tessy_testing<-read.csv(paste0(folder,"/ForDailyUpdate/tessy_national_tests.csv"))
View(tessy_testing)
View(tessy_testing)
View(tessy_testing)
testing_country<-testing_tessy %>% filter(CountryName==ctr)
testing_country<-tessy_testing %>% filter(CountryName==ctr)
ctr<-'Belgium'
testing_country<-tessy_testing %>% filter(CountryName==ctr)
View(testing_country)
TestingData<-HQTesting %>% filter(country==ctr)
testing_country<-tessy_testing %>% filter(CountryName==ctr) %>%
tessy_testing %>% filter(CountryName==ctr)
View(tessy_testing)
testing_country<-tessy_testing %>% filter(CountryName==ctr)
View(testing_country)
testing_country<-tessy_testing %>% filter(CountryName==ctr) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7'))
testing_country<-tessy_testing %>% filter(CountryName==ctr) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7')
testing_country<-tessy_testing %>% filter(CountryName==ctr) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7')))
View(testing_country)
View(tessy_epi)
epi_country<-tessy_epi %>% filter(CountryName==ctr)
View(testing_country)
testing_country<-tessy_testing %>% filter(CountryName==ctr) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7'))) %>% select(CountryName,date,TestedAll)
epi_country<-tessy_epi %>% filter(CountryName==ctr) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7')))
View(epi_country)
epi_country<-tessy_epi %>% filter(CountryName==ctr) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7'))) %>% select(ReportingCountry,NumberOfCases,date)
testing_data<-testing_country %>% left_join(epi_country,by = c("CountryName",'date'))
View(epi_country)
testing_country<-tessy_testing %>% filter(CountryName==ctr) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7'))) %>% select(CountryName,date,TestedAll)
epi_country<-tessy_epi %>% filter(CountryName==ctr) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7'))) %>% select(CountryName,NumberOfCases,date)
testing_data<-testing_country %>% left_join(epi_country,by = c("CountryName",'date'))
View(testing_data)
AnalysisTestingTessy<-function(ctr){
testing_country<-tessy_testing %>% filter(CountryName==ctr) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7'))) %>% select(CountryName,date,TestedAll)
epi_country<-tessy_epi %>% filter(CountryName==ctr) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7'))) %>% select(CountryName,NumberOfCases,date)
testing_data<-testing_country %>% left_join(epi_country,by = c("CountryName",'date'))
return(testing_data)
}
knitr::opts_chunk$set(echo = TRUE)
TestingDataTessy<-AnalysisTestingTessy(Country)
ctr<-'Belgium'
TestingDataTessy<-AnalysisTestingTessy(Country)
Country
Country<-'Belgium'
TestingDataTessy<-AnalysisTestingTessy(Country)
View(TestingDataTessy)
TestingDataTessy<-TestingDatatessy %>%
mutate(positivity=round(NumberOfCases/TestedAll*100,1),
ChangeTest7Days=round(TestedAll/lag(TestedAll,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity/lag(positivity,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
TestingDataTessy<-AnalysisTestingTessy(Country)
TestingDataTessy<-TestingDatatessy %>%
mutate(positivity=round(NumberOfCases/TestedAll*100,1),
ChangeTest7Days=round(TestedAll/lag(TestedAll,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity/lag(positivity,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
TestingDataTessy<-TestingDataTessy %>%
mutate(positivity=round(NumberOfCases/TestedAll*100,1),
ChangeTest7Days=round(TestedAll/lag(TestedAll,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity/lag(positivity,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
View(TestingDataTessy)
TestingDataTessy<-AnalysisTestingTessy(Country)
if(nrow(TestingDataTessy)!=0){
TestingDataTessy<-TestingDataTessy %>%
mutate(positivity=round(NumberOfCases/TestedAll*100,1),
ChangeTest7Days=round(TestedAll/lag(TestedAll,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity/lag(positivity,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
LatestDateTessy<-max(TestingData$date)
TestingDataLatestDateTessy<-TestingDataTessy %>% filter(date==LatestDateTessy)
TextTestingTessy<-paste0('As of ',LatestDateTessy, ', there had been ', TestingDataLatestDateTessy$TestedAll,' tests over the previous 7 days (a ', TestingDataLatestDateTessy$ChangeTest7DaysAbs, '% ',TestingDataLatestDateTessy$TrendTest7Days, ' compared to one week earlier), the positivity rate was ',TestingDataLatestDateTessy$positivity, '%, which represents a ',TestingDataLatestDateTessy$ChangePositivityAbs,'% ',TestingDataLatestDateTessy$TrendPositivity,' compared to one week earlier.')
} else {
TextTestingTessy<-paste0('No HQ data for testing for ',Country)
}
TextTestingTessy
TestingDataTessy<-AnalysisTestingTessy(Country)
View(TestingDataTessy)
TestingDataTessy<-TestingDataTessy %>%
mutate(positivity=round(NumberOfCases/TestedAll*100,1),
ChangeTest7Days=round(TestedAll/lag(TestedAll,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity/lag(positivity,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
TestingDataTessy<-TestingDataTessy %>%
mutate(positivity=round(NumberOfCases/TestedAll*100,1),
ChangeTest7Days=round(TestedAll/lag(TestedAll,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity/lag(positivity,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
LatestDateTessy<-max(TestingDataTessy$date)
TestingDataLatestDateTessy<-TestingDataTessy %>% filter(date==LatestDateTessy)
TextTestingTessy<-paste0('As of ',LatestDateTessy, ', there had been ', TestingDataLatestDateTessy$TestedAll,' tests over the previous 7 days (a ', TestingDataLatestDateTessy$ChangeTest7DaysAbs, '% ',TestingDataLatestDateTessy$TrendTest7Days, ' compared to one week earlier), the positivity rate was ',TestingDataLatestDateTessy$positivity, '%, which represents a ',TestingDataLatestDateTessy$ChangePositivityAbs,'% ',TestingDataLatestDateTessy$TrendPositivity,' compared to one week earlier.')
TextTestingTessy
for (Country in CountriesOfInterest$ADM0NAME){
render(paste0(folder_,"\\Generation_Narratives.Rmd"),output_file=paste0(OutputFolder,"/SlideDeck/","Narratives_",Country),word_document(reference_doc= "Template.docx"))
}
CountriesOfInterest<-read.csv(paste0(folder,"/ForDailyUpdate/CountriesOfInterest.csv")) %>%
filter(Interest=="Yes")
for (Country in CountriesOfInterest$ADM0NAME){
render(paste0(folder_,"\\Generation_Narratives.Rmd"),output_file=paste0(OutputFolder,"/SlideDeck/","Narratives_",Country),word_document(reference_doc= "Template.docx"))
}
#### 1 - Initial set-up ####
#Cleans everything (any previously datasets, functions created,..)
rm(list = ls())
#### 1.A - Call of packages needed in the script ####
# Checks first if they are already installed and installs them if they're not
PackagesToInstall<-c('devtools','data.table','ISOweek',"hablar","ggsci",'BBmisc',"stringr","magick","gridExtra","lubridate","readxl","RColorBrewer","ggplot2","dplyr","rmarkdown","kableExtra","flextable","ggpubr","knitr","scales","tidyr","scales","xml2","rvest","qdapRegex",'cowplot','WHOCountryNames')
for (i in PackagesToInstall) {
print(i)
if (!i %in% installed.packages())
{install.packages(i)}
library(i, character.only = TRUE)
}
#### 1.B - Reads all datasets necessary for the script and do some adaptations, reformating or basic calculations ####
#Reads where the file 'ScriptToRun.R' is stored
folder_<-dirname(rstudioapi::getSourceEditorContext()$path)
folderOutGit<-dirname(dirname(folder_))
folder<-paste0(folderOutGit,'/InOutSlideDeck')
Dataset_Epiforecast_ <- read.csv("https://raw.githubusercontent.com/epiforecasts/covid-rt-estimates/master/national/cases/summary/rt.csv") %>%
filter(type=='estimate')
Dataset_GlobalPopulation<-read.csv(paste0(folder,"/NoUpdateNeeded/ref_Country.csv")) %>%
select(ADM0NAME,UNPOP2019) %>% mutate(ADM0NAME=str_to_title(ADM0NAME))
MainDataset<-read.csv(paste0(folder,"/ForDailyUpdate/qry_COVID_running_cases_country_date.csv")) %>%
mutate(DateReport1=as.Date(parse_date_time(DateReport1, c("dmy", "ymd","mdy"))),ADM0NAME=str_to_title(ADM0NAME)) %>%
left_join(Dataset_GlobalPopulation,by="ADM0NAME")
JRCDataset<-read.csv('https://raw.githubusercontent.com/ec-jrc/COVID-19/master/data-by-country/jrc-covid-19-all-days-by-country.csv') %>%
mutate(CountryName=if_else(CountryName=='Moldova','Republic Of Moldova',CountryName)) %>%
mutate(CountryName=str_to_title(CountryName))
ECDC_Hosp<-read_excel(paste0(folder,"/ForDailyUpdate/ECDC_HospICU.xlsx"))
Vaccines_Tracker<-read.csv(paste0(folder,'/ForDailyUpdate/data_for_mapping_vaccines.csv'))
HQTesting<-read_excel(paste0(folder,"/ForDailyUpdate/HQ_Testing.xlsx"))
tessy_epi<-read.csv(paste0(folder,"/ForDailyUpdate/tessy_aggregated.csv"))
tessy_testing<-read.csv(paste0(folder,"/ForDailyUpdate/tessy_national_tests.csv"))
#### 2 - Analysis ####
AnalysisRtPerCountry<-function(ctr){
Dataset_Epiforecast_Country<-Dataset_Epiforecast_ %>% filter(country==ctr)
Dataset_Epiforecast_Country <- Dataset_Epiforecast_Country %>%
select(date,country,R=median) %>%
arrange(date) %>%
mutate(Trend=if_else(lag(R,1)>=lag(R,0),'decreasing','increasing'),
AboveBelow=if_else(R>1,'above 1','below 1'),
TrendDays:= rowid(rleid(Trend)),
AboveBelowDays := rowid(rleid(AboveBelow)))
return(Dataset_Epiforecast_Country)
}
AnalysisEpi<-function(ctr){
CountryPopulation<-(Dataset_GlobalPopulation %>% filter(ADM0NAME==ctr))$UNPOP2019
CountryEpiDataset<-MainDataset %>% filter(ADM0NAME==ctr)
maxDate<-max(CountryEpiDataset$DateReport1)
CountryEpiDataset <-CountryEpiDataset %>%
mutate(Cases_Last7Days=TotalCases-lag(TotalCases,7),
Cases_Incidence7Days=Cases_Last7Days/CountryPopulation*100000,
Cases_PercChange7Days=Cases_Incidence7Days/lag(Cases_Incidence7Days,7)*100-100,
Cases_Trend7DaysIncidence=if_else(Cases_PercChange7Days<=0,'decrease','increase'),
Cases_AbsolutePercChange=abs(round(Cases_PercChange7Days,1)),
Deaths_Last7Days=TotalDeaths-lag(TotalDeaths,7),
Deaths_Incidence7Days=Deaths_Last7Days/CountryPopulation*100000,
Deaths_PercChange7Days=Deaths_Incidence7Days/lag(Deaths_Incidence7Days,7)*100-100,
Deaths_Trend7DaysIncidence=if_else(Deaths_PercChange7Days<=0,'decrease','increase'),
Deaths_AbsolutePercChange=abs(round(Deaths_PercChange7Days,1)))
return(CountryEpiDataset)
}
AnalysisJRC<-function(ctr){
JRCCountry<-JRCDataset %>% filter(CountryName==ctr)
JRCCountry<-JRCCountry %>%
mutate(PercChangeHosp_7Days=round(Hospitalized/lag(Hospitalized,7)*100-100,1),
TrendHosp=if_else(PercChangeHosp_7Days>0,'increase','decrease'),
PercChangeICU_7Days=round(IntensiveCare/lag(IntensiveCare,7)*100-100,1),
TrendICU=if_else(PercChangeICU_7Days>0,'increase','decrease'))
return(JRCCountry)
}
AnalysisECDC_Hosp<-function(ctr){
ECDCCountry_Hosp<-ECDC_Hosp %>% filter(country==ctr)
return(ECDCCountry_Hosp)
}
AnalysisVaccineTracker<-function(ctr){
Vaccine_Country<-Vaccines_Tracker %>% filter(report_country==ctr)
return(Vaccine_Country)
}
AnalysisTesting<-function(ctr){
TestingData<-HQTesting %>% filter(country==ctr)
return(TestingData)
}
AnalysisTestingTessy<-function(ctr){
testing_country<-tessy_testing %>% filter(CountryName==ctr) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7'))) %>% select(CountryName,date,TestedAll)
epi_country<-tessy_epi %>% filter(CountryName==ctr) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7'))) %>% select(CountryName,NumberOfCases,date)
testing_data<-testing_country %>% left_join(epi_country,by = c("CountryName",'date'))
return(testing_data)
}
# Preparing number formatting
plain <- function(x,...) {
format(x, ..., scientific = FALSE, trim = TRUE,big.mark=" ")
}
# Preparing folder structure
CurrentDate<-max(MainDataset$DateReport1)
FirstDate<-min(MainDataset$DateReport1)
dir.create(paste0(folder,"/",CurrentDate))
OutputFolder<-paste0(folder,"/",CurrentDate)
dir.create(paste0(OutputFolder,"/Charts"))
dir.create(paste0(OutputFolder,"/SlideDeck"))
#
# DatasetTesting<-read.csv(paste0(folder,"/ForDailyUpdate//data_export_NCOV_WEEK_AGG_EURO.csv")) %>% filter(AGE_GROUP_FK=='All') %>%
#   mutate(WEEK_START_DATE=as.Date(parse_date_time(WEEK_START_DATE, c("dmy", "ymd","mdy")))) %>%
#   mutate(ï..REPORT_COUNTRY_FK=if_else(ï..REPORT_COUNTRY_FK=='Bosnia and Herzegovina','Bosnia And Herzegovina',ï..REPORT_COUNTRY_FK)) %>%
#   mutate(ï..REPORT_COUNTRY_FK=if_else(ï..REPORT_COUNTRY_FK=='Kosovo (in accordance with Security Council resolution 1244 (1999))','Kosovo',ï..REPORT_COUNTRY_FK)) %>%
#   mutate(ï..REPORT_COUNTRY_FK=if_else(ï..REPORT_COUNTRY_FK=='Czechia','Czech Republic',ï..REPORT_COUNTRY_FK)) %>%
#   mutate(ï..REPORT_COUNTRY_FK=if_else(ï..REPORT_COUNTRY_FK=='Republic of Moldova','Republic Of Moldova',ï..REPORT_COUNTRY_FK))
# Might need to check if this DatasetTesting is created properly, the field name on Country is acting strange
CountriesPerRegion<-read.csv(paste0(folder,"/ForDailyUpdate/CountriesOfInterest.csv")) %>% select(ADM0NAME,Region)
CountriesOfInterest<-read.csv(paste0(folder,"/ForDailyUpdate/CountriesOfInterest.csv")) %>%
filter(Interest=="Yes")
WorldRegions_Data<-read.csv(paste0(folder,"/ForDailyUpdate/WorldRegions_Data.csv"))
SubnationalDataset<-read.csv(paste0(folder,"/ForDailyUpdate/SubnationalDataset.csv"),encoding = "UTF-8")
SubnationalDataset<-WHOCountryNames(SubnationalDataset,CountryName)
KeyMessages<-read_excel(paste0(folder,"/ForDailyUpdate/KeyMessages.xlsx"))
PHSMNarratives<-read_excel(paste0(folder,"/ForDailyUpdate/PHSM_Narratives.xlsx"))
EventsInterest<-read_excel(paste0(folder,"/ForDailyUpdate/EventsInterest.xlsx"))
for (Country in CountriesOfInterest$ADM0NAME){
render(paste0(folder_,"\\Generation_Narratives.Rmd"),output_file=paste0(OutputFolder,"/SlideDeck/","Narratives_",Country),word_document(reference_doc= "Template.docx"))
}
Country
TestingDataTessy<-AnalysisTestingTessy(Country)
testing_country<-tessy_testing %>% filter(CountryName==ctr) %>%
select(CountryName,DateUsedForStatisticsISO,TestedAll)
epi_country<-tessy_epi %>% filter(CountryName==ctr) %>%
select(CountryName,NumberOfCases,DateUsedForStatisticsISO)
testing_data<-testing_country %>% left_join(epi_country,by = c("CountryName",'DateUsedForStatisticsISO'))
testing_country<-tessy_testing %>% filter(CountryName==ctr) %>%
select(CountryName,DateUsedForStatisticsISO,TestedAll)
ctr
ctr<-'Belgium'
testing_country<-tessy_testing %>% filter(CountryName==ctr) %>%
select(CountryName,DateUsedForStatisticsISO,TestedAll)
AnalysisTestingTessy<-function(ctr){
testing_country<-tessy_testing %>% filter(CountryName==ctr) %>%
select(CountryName,DateUsedForStatisticsISO,TestedAll)
epi_country<-tessy_epi %>% filter(CountryName==ctr) %>%
select(CountryName,NumberOfCases,DateUsedForStatisticsISO)
testing_data<-testing_country %>% left_join(epi_country,by = c("CountryName",'DateUsedForStatisticsISO'))
return(testing_data)
}
AnalysisTestingTessy(ctr)
TestingDataTessy<-AnalysisTestingTessy(Country) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7'))
TestingDataTessy<-AnalysisTestingTessy(Country) %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7')))
TestingDataTessy<-AnalysisTestingTessy(Country)
if(nrow(TestingDataTessy)!=0){
TestingDataTessy<-TestingDataTessy %>%
mutate(date=ISOweek2date(paste0(DateUsedForStatisticsISO,'-7')),
positivity=round(NumberOfCases/TestedAll*100,1),
ChangeTest7Days=round(TestedAll/lag(TestedAll,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity/lag(positivity,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
LatestDateTessy<-max(TestingDataTessy$date)
TestingDataLatestDateTessy<-TestingDataTessy %>% filter(date==LatestDateTessy)
TextTestingTessy<-paste0('As of ',LatestDateTessy, ', there had been ', TestingDataLatestDateTessy$TestedAll,' tests over the previous 7 days (a ', TestingDataLatestDateTessy$ChangeTest7DaysAbs, '% ',TestingDataLatestDateTessy$TrendTest7Days, ' compared to one week earlier), the positivity rate was ',TestingDataLatestDateTessy$positivity, '%, which represents a ',TestingDataLatestDateTessy$ChangePositivityAbs,'% ',TestingDataLatestDateTessy$TrendPositivity,' compared to one week earlier.')
} else {
TextTestingTessy<-paste0('No HQ data for testing for ',Country)
}
for (Country in CountriesOfInterest$ADM0NAME){
render(paste0(folder_,"\\Generation_Narratives.Rmd"),output_file=paste0(OutputFolder,"/SlideDeck/","Narratives_",Country),word_document(reference_doc= "Template.docx"))
}
for (Country in CountriesOfInterest$ADM0NAME){
render(paste0(folder_,"\\Generation_Narratives.Rmd"),output_file=paste0(OutputFolder,"/SlideDeck/","Narratives_",Country),word_document(reference_doc= "Template.docx"))
}
VaccineData<-AnalysisVaccineTracker(Country)
View(VaccineData)
Country
Country<-'Belgium'
VaccineData<-AnalysisVaccineTracker(Country)
View(VaccineData)
View(tessy_epi)
View(ECDC_Hosp)
ECDC_Testing<-read_excel(paste0(folder,"/ForDailyUpdate/ECDC_Testing.xlsx"))
View(ECDC_Testing)
AnalysisECDC_Testing<-function(ctr){
ECDCCountry_Testing<-ECDC_Testing %>% filter(country==ctr)
return(ECDCCountry_Testing)
}
TestingDataECDC<-AnalysisECDC_Testing(Country)
View(TestingDataECDC)
TestingDataECDC<-TestingDataECDC %>%
mutate(date=ISOweek2date(paste0(year_week,'-7')))
View(TestingDataECDC)
TestingDataECDC<-AnalysisECDC_Testing(Country)
View(TestingDataECDC)
TestingDataECDC<-TestingDataECDC %>%
mutate(date=ISOweek2date(paste0(year_week,'-7')),
ChangeTest7Days=round(tests_done/lag(tests_done,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity_rate/lag(positivity_rate,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
LatestDateECDC<-max(TestingDataECDC$date)
TestingDataLatestDateECDC<-TestingDataECDC %>% filter(date==LatestDateTessy)
TestingDataECDC<-AnalysisECDC_Testing(Country)
if(nrow(TestingDataECDC)!=0){
TestingDataECDC<-TestingDataECDC %>%
mutate(date=ISOweek2date(paste0(year_week,'-7')),
ChangeTest7Days=round(tests_done/lag(tests_done,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity_rate/lag(positivity_rate,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
LatestDateECDC<-max(TestingDataECDC$date)
TestingDataLatestDateECDC<-TestingDataECDC %>% filter(date==LatestDateTessy)
TextTestingECDC<-paste0('As of ',LatestDateECDC, ', there had been ', TestingDataLatestDateECDC$tests_done,' tests over the previous 7 days (a ', TestingDataLatestDateECDC$ChangeTest7DaysAbs, '% ',TestingDataLatestDateECDC$TrendTest7Days, ' compared to one week earlier), the positivity rate was ',TestingDataLatestDateECDC$positivity, '%, which represents a ',TestingDataLatestDateECDC$ChangePositivityAbs,'% ',TestingDataLatestDateECDC$TrendPositivity,' compared to one week earlier.')
} else {
TextTestingECDC<-paste0('No HQ data for testing for ',Country)
}
TestTestingECDC
TextTestingECDC
TestingDataLatestDateECDC
View(TestingDataLatestDateECDC)
Country
TestingDataECDC<-AnalysisECDC_Testing(Country)
TestingDataECDC<-TestingDataECDC %>%
mutate(date=ISOweek2date(paste0(year_week,'-7')),
ChangeTest7Days=round(tests_done/lag(tests_done,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity_rate/lag(positivity_rate,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
View(TestingDataECDC)
LatestDateECDC<-max(TestingDataECDC$date)
LatestDateECDC
TestingDataLatestDateECDC<-TestingDataECDC %>% filter(date==LatestDateTessy)
View(TestingDataLatestDateECDC)
TestingDataECDC<-TestingDataECDC %>%
mutate(date=ISOweek2date(paste0(year_week,'-7')),
ChangeTest7Days=round(tests_done/lag(tests_done,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity_rate/lag(positivity_rate,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
TestingDataECDC<-AnalysisECDC_Testing(Country)
if(nrow(TestingDataECDC)!=0){
TestingDataECDC<-TestingDataECDC %>%
mutate(date=ISOweek2date(paste0(year_week,'-7')),
ChangeTest7Days=round(tests_done/lag(tests_done,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity_rate/lag(positivity_rate,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
LatestDateECDC<-max(TestingDataECDC$date)
TestingDataLatestDateECDC<-TestingDataECDC %>% filter(date==LatestDateECDC)
TextTestingECDC<-paste0('As of ',LatestDateECDC, ', there had been ', TestingDataLatestDateECDC$tests_done,' tests over the previous 7 days (a ', TestingDataLatestDateECDC$ChangeTest7DaysAbs, '% ',TestingDataLatestDateECDC$TrendTest7Days, ' compared to one week earlier), the positivity rate was ',TestingDataLatestDateECDC$positivity, '%, which represents a ',TestingDataLatestDateECDC$ChangePositivityAbs,'% ',TestingDataLatestDateECDC$TrendPositivity,' compared to one week earlier.')
} else {
TextTestingECDC<-paste0('No HQ data for testing for ',Country)
}
TextTestingECDC
TestingDataECDC<-AnalysisECDC_Testing(Country)
if(nrow(TestingDataECDC)!=0){
TestingDataECDC<-TestingDataECDC %>%
mutate(date=ISOweek2date(paste0(year_week,'-7')),
ChangeTest7Days=round(tests_done/lag(tests_done,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity_rate/lag(positivity_rate,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
LatestDateECDC<-max(TestingDataECDC$date)
TestingDataLatestDateECDC<-TestingDataECDC %>% filter(date==LatestDateECDC)
TextTestingECDC<-paste0('As of ',LatestDateECDC, ', there had been ', TestingDataLatestDateECDC$tests_done,' tests over the previous 7 days (a ', TestingDataLatestDateECDC$ChangeTest7DaysAbs, '% ',TestingDataLatestDateECDC$TrendTest7Days, ' compared to one week earlier), the positivity rate was ',TestingDataLatestDateECDC$positivity_rate, '%, which represents a ',TestingDataLatestDateECDC$ChangePositivityAbs,'% ',TestingDataLatestDateECDC$TrendPositivity,' compared to one week earlier.')
} else {
TextTestingECDC<-paste0('No HQ data for testing for ',Country)
}
TextTestingECDC<-paste0('No HQ data for testing for ',Country)
TestingDataECDC<-AnalysisECDC_Testing(Country)
if(nrow(TestingDataECDC)!=0){
TestingDataECDC<-TestingDataECDC %>%
mutate(date=ISOweek2date(paste0(year_week,'-7')),
ChangeTest7Days=round(tests_done/lag(tests_done,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity_rate/lag(positivity_rate,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
LatestDateECDC<-max(TestingDataECDC$date)
TestingDataLatestDateECDC<-TestingDataECDC %>% filter(date==LatestDateECDC)
TextTestingECDC<-paste0('As of ',LatestDateECDC, ', there had been ', TestingDataLatestDateECDC$tests_done,' tests over the previous 7 days (a ', TestingDataLatestDateECDC$ChangeTest7DaysAbs, '% ',TestingDataLatestDateECDC$TrendTest7Days, ' compared to one week earlier), the positivity rate was ',TestingDataLatestDateECDC$positivity_rate, '%, which represents a ',TestingDataLatestDateECDC$ChangePositivityAbs,'% ',TestingDataLatestDateECDC$TrendPositivity,' compared to one week earlier.')
} else {
TextTestingECDC<-paste0('No HQ data for testing for ',Country)
}
TextTestingECDC
TestingDataECDC<-AnalysisECDC_Testing(Country)
if(nrow(TestingDataECDC)!=0){
TestingDataECDC<-TestingDataECDC %>%
mutate(date=ISOweek2date(paste0(year_week,'-7')),
ChangeTest7Days=round(tests_done/lag(tests_done,1)*100-100,1),
ChangeTest7DaysAbs=abs(ChangeTest7Days),
TrendTest7Days=if_else(ChangeTest7Days>0,'increase','decrease'),
ChangePositivity=round(positivity_rate/lag(positivity_rate,1)*100-100,1),
ChangePositivityAbs=abs(ChangePositivity),
TrendPositivity=if_else(ChangePositivity>0,'increase','decrease'))
LatestDateECDC<-max(TestingDataECDC$date)
TestingDataLatestDateECDC<-TestingDataECDC %>% filter(date==LatestDateECDC)
TextTestingECDC<-paste0('As of ',LatestDateECDC, ', there had been ', TestingDataLatestDateECDC$tests_done,' tests over the previous 7 days (a ', TestingDataLatestDateECDC$ChangeTest7DaysAbs, '% ',TestingDataLatestDateECDC$TrendTest7Days, ' compared to one week earlier), the positivity rate was ',round(TestingDataLatestDateECDC$positivity_rate,1), '%, which represents a ',TestingDataLatestDateECDC$ChangePositivityAbs,'% ',TestingDataLatestDateECDC$TrendPositivity,' compared to one week earlier.')
} else {
TextTestingECDC<-paste0('No HQ data for testing for ',Country)
}
TextTestingECDC
for (Country in CountriesOfInterest$ADM0NAME){
render(paste0(folder_,"\\Generation_Narratives.Rmd"),output_file=paste0(OutputFolder,"/SlideDeck/","Narratives_",Country),word_document(reference_doc= "Template.docx"))
}
rsconnect::showLogs('worldhealthorg','euro-covid19')
rsconnect::showLogs(account='worldhealthorg','euro-covid19')
rsconnect::showLogs(account='worldhealthorg',appName='euro-covid19')
shiny::runApp('~/GitHub/euro_covid_app/aggregate-app')
library(devtools)
install_github('romanceline/Packages/WHOCountryNames')
#### 1 - Initial set-up ####
#Cleans everything (any previously datasets, functions created,..)
rm(list = ls())
#### 1.A - Call of packages needed in the script ####
# Checks first if they are already installed and installs them if they're not
PackagesToInstall<-c('devtools','data.table','ISOweek',"hablar","ggsci",'BBmisc',"stringr","magick","gridExtra","lubridate","readxl","RColorBrewer","ggplot2","dplyr","rmarkdown","kableExtra","flextable","ggpubr","knitr","scales","tidyr","scales","xml2","rvest","qdapRegex",'cowplot','WHOCountryNames')
for (i in PackagesToInstall) {
print(i)
if (!i %in% installed.packages())
{install.packages(i)}
library(i, character.only = TRUE)
}
#### 1.B - Reads all datasets necessary for the script and do some adaptations, reformating or basic calculations ####
#Reads where the file 'ScriptToRun.R' is stored
folder_<-dirname(rstudioapi::getSourceEditorContext()$path)
folderOutGit<-dirname(dirname(folder_))
folder<-paste0(folderOutGit,'/InOutSlideDeck')
Dataset_Epiforecast_ <- read.csv("https://raw.githubusercontent.com/epiforecasts/covid-rt-estimates/master/national/cases/summary/rt.csv") %>%
filter(type=='estimate')
Dataset_GlobalPopulation<-read.csv(paste0(folder,"/NoUpdateNeeded/ref_Country.csv")) %>%
select(ADM0NAME,UNPOP2019) %>% mutate(ADM0NAME=str_to_title(ADM0NAME))
MainDataset<-read.csv(paste0(folder,"/ForDailyUpdate/qry_COVID_running_cases_country_date.csv")) %>%
mutate(DateReport1=as.Date(parse_date_time(DateReport1, c("dmy", "ymd","mdy"))),ADM0NAME=str_to_title(ADM0NAME)) %>%
left_join(Dataset_GlobalPopulation,by="ADM0NAME")
JRCDataset<-read.csv('https://raw.githubusercontent.com/ec-jrc/COVID-19/master/data-by-country/jrc-covid-19-all-days-by-country.csv') %>%
mutate(CountryName=if_else(CountryName=='Moldova','Republic Of Moldova',CountryName)) %>%
mutate(CountryName=str_to_title(CountryName))
ECDC_Hosp<-read_excel(paste0(folder,"/ForDailyUpdate/ECDC_HospICU.xlsx"))
ECDC_Testing<-read_excel(paste0(folder,"/ForDailyUpdate/ECDC_Testing.xlsx"))
Vaccines_Tracker<-read.csv(paste0(folder,'/ForDailyUpdate/data_for_mapping_vaccines.csv'))
Severity_Web<-read.csv(paste0(folder,'/ForDailyUpdate/SeverityWeb.csv')) %>%
WHOCountryNames(ADM0NAME)
View(Severity_Web)
setwd('C:/Users/romanc/Documents/GitHub/Packages/WHOCountryNames')
document()
install_github('romanceline/Packages/WHOCountryNames')
